<!DOCTYPE html>
<html lang="en">
<head>
	<script>
    // Check if user is authenticated
    if (localStorage.getItem('authenticated') !== 'true') {
        window.location.href = "index.html";
    }
    
    // Optional: Add logout functionality
    function logout() {
        localStorage.removeItem('authenticated');
        window.location.href = "index.html";
    }
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TAHA School">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Add viewport meta tag for better mobile experience -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>TAHA School Management System</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-light: #f0f2f5;
            --border: #dee2e6;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
           max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            color: white;
        }
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }
        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .tab.active {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: 600;
        }
        .tab-content {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        .tab-content.active {
            display: block;
        }
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        .btn-warning:hover {
            background: #e68a00;
        }
        h2 {
            margin-bottom: 25px;
            color: var(--secondary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }
        h3 {
            margin: 20px 0 15px 0;
            color: var(--primary);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-light);
            border-radius: 12px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        input, select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        .btn {
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-danger {
            background: var(--danger);
        }
        .btn-danger:hover {
            background: #d1146a;
        }
        .btn-info {
            background: var(--info);
        }
        .btn-info:hover {
            background: #3079d6;
        }
        .btn-success {
            background: #2ecc71;
        }
        .btn-success:hover {
            background: #27ae60;
        }
        .child-section {
            position: relative;
            padding: 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }
        .child-section h4 {
            margin-top: 0;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        .search-box input {
            flex: 1;
            margin-bottom: 0;
        }
        .table-wrap {
  max-height: 600px;           /* Limits height */
  overflow-y: auto;            /* Adds vertical scrollbar */
  overflow-x: auto;            /* Adds horizontal scrollbar if needed */
  border: 1px solid #ddd;      /* Optional: adds border */
  border-radius: 12px;         /* Rounded corners */
  margin-bottom: 20px;
  background: white;
}
    #databaseTable {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px; /* Ensures it doesn’t shrink too much */
}

#databaseTable th,
#databaseTable td {
  padding: 12px 10px;
  text-align: left;
  white-space: nowrap; /* Prevents text from wrapping */
}    
	table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background: rgba(67, 97, 238, 0.05);
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            width: 600px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
        }
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            display: none;
            align-items: center;
            gap: 10px;
        }
        .toast.success {
            background: #2ecc71;
        }
        .toast.error {
            background: var(--danger);
        }
        .toast.warning {
            background: var(--warning);
        }
        .toast.info {
            background: var(--info);
        }
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stats-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }
        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .stats-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stats-card .label {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        .calendar-container {
            margin-top: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-grid .header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: 500;
        }
        .calendar-day:hover {
            background: rgba(67, 97, 238, 0.1);
        }
        .calendar-day.present {
            background: #d4edda;
            color: #155724;
        }
        .calendar-day.absent {
            background: #f8d7da;
            color: #721c24;
        }
        .calendar-day.late {
            background: #fff3cd;
            color: #856404;
        }
        .calendar-day.weekend {
            background: #f8f9fa;
            color: #6c757d;
        }
        .calendar-day.today {
            border: 2px solid var(--primary);
        }
        .attendance-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .student-item {
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }
        .student-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .student-item.selected {
            border: 2px solid var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        .student-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .student-grade {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        .attendance-status {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
        }
        .months-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .month-card {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }
        .month-card h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
        }
        .month-stats {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .print-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .print-header img {
            max-width: 100px;
            margin-bottom: 10px;
        }
        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .print-table th,
        .print-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .print-table th {
            background: #f2f2f2;
        }
        .error {
            border-color: var(--danger) !important;
        }
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: -10px;
            margin-bottom: 15px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            .search-box {
                flex-direction: column;
            }
            .months-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .logo-container {
            perspective: 1000px;
            margin-right: 20px;
        }
        .logo {
            width: 100px;
            height: 100px;
            transform-style: preserve-3d;
            transform: rotateY(20deg);
            transition: transform 0.5s;
        }
        .logo:hover {
            transform: rotateY(0deg);
        }
 .ios-clock-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-left: 20px;
}
.ios-clock {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    background: #000;
    position: relative;
    box-shadow: 
        0 0 0 4px rgba(255,255,255,0.1),
        inset 0 0 0 3px rgba(255,255,255,0.1),
        inset 0 0 10px rgba(0,0,0,0.5),
        0 10px 20px rgba(0,0,0,0.5);
}
.ios-clock-face {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}
.ios-minute-marks {
    position: absolute;
    width: 100%;
    height: 100%;
}
.ios-minute-mark {
    position: absolute;
    width: 2px;
    height: 6px;
    background: #fff;
    left: 50%;
    top: 6px;
    margin-left: -1px;
    transform-origin: 50% 84px;
    opacity: 0.7;
}
/* Create 60 minute marks */
.ios-minute-mark:nth-child(5n+1) {
    width: 3px;
    height: 12px;
    margin-left: -1.5px;
    opacity: 1;
}
.ios-hour-hand {
    position: absolute;
    width: 6px;
    height: 50px;
    background: #fff;
    left: 50%;
    top: 50%;
    margin-left: -3px;
    margin-top: -50px;
    border-radius: 4px;
    transform-origin: 50% 100%;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    z-index: 3;
}
.ios-minute-hand {
    position: absolute;
    width: 4px;
    height: 70px;
    background: #fff;
    left: 50%;
    top: 50%;
    margin-left: -2px;
    margin-top: -70px;
    border-radius: 4px;
    transform-origin: 50% 100%;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    z-index: 2;
}
.ios-second-hand {
    position: absolute;
    width: 2px;
    height: 80px;
    background: #ff3b30;
    left: 50%;
    top: 50%;
    margin-left: -1px;
    margin-top: -80px;
    border-radius: 2px;
    transform-origin: 50% 100%;
    z-index: 1;
}
.ios-center-cap {
    position: absolute;
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    left: 50%;
    top: 50%;
    margin-left: -6px;
    margin-top: -6px;
    z-index: 4;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
}
.ios-digital-display {
    position: absolute;
    bottom: 20px;
    width: 100%;
    text-align: center;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}
.ios-time {
    font-size: 1.5rem;
    font-weight: 600;
    letter-spacing: 1px;
}
.ios-date {
    font-size: 0.8rem;
    opacity: 0.8;
    margin-top: 5px;
}
.ios-clock-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-left: 20px;
  gap: 10px; /* space between clock and digital */
}

.ios-clock {
  width: 150px !important;
  height: 150px !important;
  border-radius: 50%;
  background: #000;
  position: relative;
  box-shadow: 
    0 0 0 3px rgba(255,255,255,0.1),
    inset 0 0 10px rgba(0,0,0,0.5),
    0 10px 20px rgba(0,0,0,0.5);
}

.ios-digital-display {
  position: static; /* No absolute positioning */
  text-align: center;
  padding: 5px 0;
  width: 100%;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

.ios-time {
  font-size: 1.2rem;
  font-weight: 600;
  letter-spacing: 1px;
}

.ios-date {
  font-size: 0.8rem;
  opacity: 0.9;
  margin-top: 2px;
}
	@media (max-width: 480px) {
  .ios-clock {
    width: 120px !important;
    height: 120px !important;
  }
  .ios-digital-display {
    font-size: 1rem;
  }
  .ios-time {
    font-size: 1.1rem;
  }
}
	/* iOS Modern Theme for Reports */
#reportsTab {
    background: #F2F2F7;
    border-radius: 20px;
    padding: 30px;
}
#reportsTab h2 {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    font-size: 1.8rem;
    font-weight: 600;
    color: #1C1C1E;
    margin-bottom: 20px;
}
.stats-card {
    background: #FFFFFF;
    border-radius: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    padding: 20px;
    transition: transform 0.2s ease;
}
.stats-card:hover {
    transform: scale(1.02);
}
.stats-card i {
    color: #007AFF;
}
.section {
    background: #FFFFFF;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.08);
}
canvas {
    background: #FAFAFA;
    border-radius: 16px;
    padding: 10px;
}
/* CLV Form Styles */
.clv-form-container {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}
.clv-header {
    text-align: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--primary);
}
.clv-section {
    margin-bottom: 25px;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 12px;
}
.clv-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
.clv-field {
    margin-bottom: 15px;
}
.clv-field label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}
.clv-field input, 
.clv-field select, 
.clv-field textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
}
.clv-field textarea {
    min-height: 100px;
    resize: vertical;
}
.clv-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 20px;
}
.clv-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
.clv-table th, 
.clv-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}
.clv-table th {
    background: var(--primary);
    color: white;
}
.clv-table tr:hover {
    background: rgba(67, 97, 238, 0.05);
}
.clv-status {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}
.status-pending {
    background: #fff3cd;
    color: #856404;
}
.status-completed {
    background: #d4edda;
    color: #155724;
}
.status-review {
    background: #cce5ff;
    color: #004085;
}
/* Image upload styles */
.image-upload-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 15px 0;
}
.image-preview {
    width: 200px;
    height: 200px;
    border: 2px dashed var(--border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 15px;
}
.image-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
.upload-btn {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}
/* Tabs for CLV sections */
.clv-tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
}
.clv-tab {
    padding: 12px 20px;
    cursor: pointer;
    font-weight: 500;
    border-bottom: 3px solid transparent;
}
.clv-tab.active {
    border-bottom: 3px solid var(--primary);
    color: var(--primary);
}
.clv-tab-content {
    display: none;
}
.clv-tab-content.active {
    display: block;
}
	/* Base responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .header-container {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-container {
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .ios-clock-container {
                margin-left: 0;
                margin-top: 15px;
            }
            
            .ios-clock {
                width: 140px;
                height: 140px;
            }
            
            .tabs {
                flex-direction: column;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .section {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                margin-bottom: 10px;
            }
            
            .search-box {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box input {
                margin-bottom: 10px;
            }
            
            .stats-section {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .stats-card {
                padding: 20px;
            }
            
            .stats-card i {
                font-size: 2rem;
            }
            
            .stats-card .value {
                font-size: 1.8rem;
            }
            
            .calendar-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .calendar-grid {
                min-width: 320px;
            }
            
            .calendar-day {
                font-size: 0.85rem;
            }
            
            .student-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
            }
            
            .student-item {
                padding: 12px;
            }
            
            .months-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal {
                width: 95%;
                max-height: 90%;
                padding: 20px;
            }
            
            .modal-header {
                margin-bottom: 15px;
            }
            
            .modal-header h3 {
                font-size: 1.3rem;
            }
            
            .toast {
                bottom: 20px;
                right: 20px;
                left: 20px;
                padding: 12px 20px;
            }
            
            #assistant-container {
                bottom: 15px;
                right: 15px;
            }
            
            #assistant-button {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #assistant-window {
                width: 90%;
                max-width: 350px;
                height: 400px;
                bottom: 70px;
                right: 5%;
            }
            
            #assistant-messages {
                font-size: 0.9rem;
            }
            
            .assistant-suggestion {
                font-size: 0.8rem;
                padding: 4px 10px;
            }
        }
        
        /* Small screen adjustments */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }
            
            .ios-clock {
                width: 120px;
                height: 120px;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .stats-section {
                grid-template-columns: 1fr;
            }
            
            .stats-card {
                padding: 15px;
            }
            
            .stats-card i {
                font-size: 1.8rem;
            }
            
            .stats-card .value {
                font-size: 1.6rem;
            }
            
            .student-list {
                grid-template-columns: 1fr;
            }
            
            .months-grid {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
            }
            
            .modal-header {
                padding-bottom: 10px;
            }
            
            #assistant-window {
                width: 95%;
                height: 350px;
            }
        }
        
        /* Landscape adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 10px 0;
            }
            
            header h1 {
                font-size: 1.4rem;
                margin-bottom: 5px;
            }
            
            .logo-container {
                margin-right: 10px;
            }
            
            .ios-clock-container {
                margin-left: 10px;
            }
            
            .ios-clock {
                width: 100px;
                height: 100px;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .section {
                padding: 10px;
                margin-bottom: 15px;
            }
            
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stats-card {
                padding: 10px;
            }
            
            .stats-card i {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .stats-card .value {
                font-size: 1.4rem;
                margin-bottom: 3px;
            }
            
            .calendar-day {
                font-size: 0.75rem;
            }
            
            #assistant-window {
                height: 250px;
            }
        }
        
        /* Touch-friendly adjustments */
        @media (hover: none) and (pointer: coarse) {
            .btn, .tab, .student-item, .calendar-day {
                min-height: 44px;
                min-width: 44px;
            }
            
            .btn {
                padding: 12px 20px;
            }
            
            input, select, textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .modal-header button {
                width: 40px;
                height: 40px;
                font-size: 1.5rem;
            }
        }
        
        /* iOS specific adjustments */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-text-size-adjust: 100%;
            }
            
            .tabs {
                -webkit-overflow-scrolling: touch;
            }
            
            .table-wrap {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Android specific adjustments */
        @media screen and (-webkit-min-device-pixel-ratio: 2) and (max-width: 768px) {
            .btn {
                font-weight: 500;
            }
            
            input, select, textarea {
                border-width: 1px;
            }
        }
    </style>
</head>
<body>
<div class="container">
<header>
<div class="header-container">
<div class="logo.png">
<div class="logo.png">
<img alt="Logo" src="logo.png" style="width:250px; height:200px;"/>
</div>
</div>
<div>
<h1>TAHA School Management System</h1>
<p>9-11 Patrona St, Dandenong VIC 3175 | Email: contact@taha.org.au</p>
</div>
<div class="ios-clock-container">
  <!-- Analog Clock -->
  <div class="ios-clock">
    <!-- Clock face, hands, etc. -->
    <div class="ios-clock-face">
      <div class="ios-minute-marks"></div>
      <div class="ios-hour-hand"></div>
      <div class="ios-minute-hand"></div>
      <div class="ios-second-hand"></div>
      <div class="ios-center-cap"></div>
    </div>
  </div>

  <!-- Digital Display (Outside Clock) -->
  <div class="ios-digital-display">
    <div class="ios-time"></div>
    <div class="ios-date"></div>
  </div>
</div></header>
<div class="tabs">
<div class="tab active" data-tab="formTab"> Registration</div>
<div class="tab" data-tab="databaseTab"> Students</div>
<div class="tab" data-tab="teacherTab"> Teachers</div>
<div class="tab" data-tab="attendanceTab"> Attendance</div>
<div class="tab" data-tab="feeTab"> Fee Management</div>
<div class="tab" data-tab="reportsTab"> Reports</div>
</div>
	<button onclick="logout()" style="position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 5px 10px;">
    <i class="fas fa-sign-out-alt"></i> Logout
</button>
<!-- Registration Tab -->
<div class="tab-content active" id="formTab">
<h2>Student &amp; Parent Registration</h2>
<form id="registrationForm">
<div class="section">
<h3> Parent/Guardian Details</h3>
<label>Full Name(s)</label>
<input id="parentName" pattern="[A-Za-z\s\-']+" required="" title="Only letters, spaces, hyphens, and apostrophes are allowed." type="text"/>
<div class="error-message" id="parentNameError">Please enter a valid name (letters, spaces, hyphens, apostrophes only).</div>
<label>Relationship to Student</label>
<input id="relationship" required="" type="text"/>
<div class="error-message" id="relationshipError">Please enter a valid relationship.</div>
<label>Phone Number</label>
<input id="parentPhone" pattern="[0-9\s\-\+\(\)]+" required="" title="Only digits, spaces, hyphens, plus, and parentheses are allowed." type="tel"/>
<div class="error-message" id="parentPhoneError">Please enter a valid phone number (digits, spaces, hyphens, plus, parentheses only).</div>
<label>Email Address</label>
<input id="parentEmail" required="" type="email"/>
<div class="error-message" id="parentEmailError">Please enter a valid email address.</div>
</div>
<div class="section">
<h3> Children Details</h3>
<div id="childrenContainer"></div>
<button class="btn" id="addChildBtn" onclick="addChildForm()" type="button"><i class="fas fa-plus"></i> Add Child</button>
</div>
<div class="action-buttons">
<button class="btn" onclick="saveRegistration()" type="button"><i class="fas fa-save"></i> Save Registration</button>
<button class="btn btn-warning" onclick="clearForm()" type="button"><i class="fas fa-broom"></i> Clear Form</button>
</div>
</form>
</div>
<!-- Student Database Tab -->
<div class="tab-content" id="databaseTab">
<h2>Student Database</h2>
<div class="search-box">
<input id="databaseSearch" onkeyup="filterDatabase()" placeholder="🔍 Search students by name, ID, or parent..." type="text"/>
<button class="btn btn-info" onclick="exportStudentData('excel')"><i class="fas fa-file-excel"></i> Export Excel</button>
<button class="btn btn-danger" onclick="exportStudentData('pdf')"><i class="fas fa-file-pdf"></i> Export PDF</button>
<button class="btn" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Import Data</button>
<input accept=".json,.csv,.xlsx" id="importFile" onchange="importStudentData(event)" style="display: none;" type="file"/>
</div>
<div class="table-wrap">
<table id="databaseTable">
<thead>
<tr>
<th>ID</th>
<th>Student Name</th>
<th>Grade</th>
<th>Parent Name</th>
<th>Parent Phone</th>
<th>Parent Email</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="databaseTableBody"></tbody>
</table>
</div>
</div>
<!-- Attendance Tab -->
<div class="tab-content" id="attendanceTab">
<h2>Student Attendance</h2>
<div class="student-list-section">
<div class="student-list-header">
<h3>Select Student for Attendance</h3>
<div class="student-list-search">
<i class="fas fa-search"></i>
<input id="studentSearch" onkeyup="filterStudents()" placeholder="Search students..." type="text"/>
</div>
</div>
<div class="student-list" id="studentList">
<!-- Student items will be dynamically added here -->
</div>
</div>
<button class="btn" id="backToMonthlyBtn" onclick="backToMonthlyView()" style="display:none; margin-top: 20px;"><i class="fas fa-arrow-left"></i> Back to Monthly</button>
<div id="attendanceCalendar"></div>
<div id="yearlyAttendanceView" style="display:none;"></div>
<button class="btn btn-success" onclick="saveAttendanceData()" style="margin-top: 20px;"><i class="fas fa-save"></i> Save Attendance</button>
</div>
<!-- Teacher Tab with CLV Forms -->
<div class="tab-content" id="teacherTab">
<h2>Teacher Management</h2>
<!-- CLV Tabs Navigation -->
<div class="clv-tabs">
<div class="clv-tab active" data-clv-tab="clvForm">CLV Form</div>
<div class="clv-tab" data-clv-tab="clvRecords">CLV Records</div>
<div class="clv-tab" data-clv-tab="teacherSection">Teacher Management</div>
</div>
<!-- CLV Form Section -->
<div class="clv-tab-content active" id="clvForm">
<div class="clv-form-container">
<div class="clv-header">
<h2>Child Learning Verification (CLV) Form</h2>
<p>Complete this form to document student progress and learning verification</p>
</div>
<form id="clvFormData">
<!-- Student Information -->
<div class="clv-section">
<h3>Student Information</h3>
<div class="clv-grid">
<div class="clv-field">
<label for="clvStudent">Select Student *</label>
<select id="clvStudent" required="">
<option value="">Select a student</option>
<!-- Students will be populated dynamically -->
</select>
</div>
<div class="clv-field">
<label for="clvDate">Assessment Date *</label>
<input id="clvDate" required="" type="date"/>
</div>
<div class="clv-field">
<label for="clvTeacher">Assessing Teacher *</label>
<input id="clvTeacher" readonly="" type="text"/>
</div>
<div class="clv-field">
<label for="clvTerm">School Term *</label>
<select id="clvTerm" required="">
<option value="">Select term</option>
<option value="Term 1">Term 1</option>
<option value="Term 2">Term 2</option>
<option value="Term 3">Term 3</option>
<option value="Term 4">Term 4</option>
</select>
</div>
</div>
<!-- Display selected student info -->
<div id="selectedStudentInfo" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid var(--primary);">
<h4>Student Details</h4>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
<div><strong>Student ID:</strong> <span id="studentIdDisplay"></span></div>
<div><strong>Grade:</strong> <span id="studentGradeDisplay"></span></div>
<div><strong>Current School:</strong> <span id="studentSchoolDisplay"></span></div>
<div><strong>Parent:</strong> <span id="studentParentDisplay"></span></div>
</div>
</div>
</div>
<!-- Learning Assessment -->
<div class="clv-section">
<h3>Learning Assessment</h3>
<div class="clv-grid">
<div class="clv-field">
<label for="clvSubject">Subject *</label>
<select id="clvSubject" required="">
<option value="">Select subject</option>
<option value="Quran">Quran Studies</option>
<option value="Arabic">Arabic Language</option>
<option value="Islamic">Islamic Studies</option>
<option value="Ethics">Islamic Ethics</option>
</select>
</div>
<div class="clv-field">
<label for="clvTopic">Topic/Unit *</label>
<input id="clvTopic" placeholder="E.g., Surah Al-Fatihah, Arabic Alphabet" required="" type="text"/>
</div>
<div class="clv-field">
<label for="clvLevel">Achievement Level *</label>
<select id="clvLevel" required="">
<option value="">Select level</option>
<option value="Beginning">Beginning</option>
<option value="Developing">Developing</option>
<option value="Proficient">Proficient</option>
<option value="Advanced">Advanced</option>
</select>
</div>
<div class="clv-field">
<label for="clvScore">Assessment Score</label>
<input id="clvScore" max="100" min="0" placeholder="Enter score (0-100)" type="number"/>
</div>
</div>
<div class="clv-field">
<label for="clvComments">Teacher Comments</label>
<textarea id="clvComments" placeholder="Comments on student progress, strengths, and areas for improvement"></textarea>
</div>
</div>
<!-- Skills Evaluation -->
<div class="clv-section">
<h3>Skills Evaluation</h3>
<p>Rate the student's skills in the following areas (1 = Needs Improvement, 5 = Excellent)</p>
<div class="clv-grid">
<div class="clv-field">
<label for="clvUnderstanding">Understanding of Concepts</label>
<select id="clvUnderstanding">
<option value="">Select rating</option>
<option value="1">1 - Needs Improvement</option>
<option value="2">2 - Developing</option>
<option value="3">3 - Satisfactory</option>
<option value="4">4 - Good</option>
<option value="5">5 - Excellent</option>
</select>
</div>
<div class="clv-field">
<label for="clvApplication">Application of Knowledge</label>
<select id="clvApplication">
<option value="">Select rating</option>
<option value="1">1 - Needs Improvement</option>
<option value="2">2 - Developing</option>
<option value="3">3 - Satisfactory</option>
<option value="4">4 - Good</option>
<option value="5">5 - Excellent</option>
</select>
</div>
<div class="clv-field">
<label for="clvParticipation">Class Participation</label>
<select id="clvParticipation">
<option value="">Select rating</option>
<option value="1">1 - Needs Improvement</option>
<option value="2">2 - Developing</option>
<option value="3">3 - Satisfactory</option>
<option value="4">4 - Good</option>
<option value="5">5 - Excellent</option>
</select>
</div>
<div class="clv-field">
<label for="clvBehavior">Classroom Behavior</label>
<select id="clvBehavior">
<option value="">Select rating</option>
<option value="1">1 - Needs Improvement</option>
<option value="2">2 - Developing</option>
<option value="3">3 - Satisfactory</option>
<option value="4">4 - Good</option>
<option value="5">5 - Excellent</option>
</select>
</div>
</div>
</div>
<!-- Evidence/Artifacts -->
<div class="clv-section">
<h3>Learning Evidence</h3>
<div class="clv-field">
<label>Upload Evidence (Photo of work sample, activity, etc.)</label>
<div class="image-upload-container">
<div class="image-preview" id="imagePreview">
<i class="fas fa-image" style="font-size: 48px; color: #ccc;"></i>
</div>
<input accept="image/*" id="clvImageUpload" style="display: none;" type="file"/>
<button class="upload-btn" onclick="document.getElementById('clvImageUpload').click()" type="button">
<i class="fas fa-upload"></i> Upload Image
                            </button>
</div>
</div>
<div class="clv-field">
<label for="clvEvidenceDesc">Evidence Description</label>
<textarea id="clvEvidenceDesc" placeholder="Describe what this evidence shows about the student's learning"></textarea>
</div>
</div>
<!-- Next Steps -->
<div class="clv-section">
<h3>Next Steps &amp; Recommendations</h3>
<div class="clv-field">
<label for="clvGoals">Learning Goals for Next Period</label>
<textarea id="clvGoals" placeholder="Specific goals for the student to work on"></textarea>
</div>
<div class="clv-field">
<label for="clvSupport">Recommended Support Strategies</label>
<textarea id="clvSupport" placeholder="Strategies to support the student's learning"></textarea>
</div>
<div class="clv-field">
<label for="clvParentComm">Parent Communication Notes</label>
<textarea id="clvParentComm" placeholder="Notes on communication with parents about this assessment"></textarea>
</div>
</div>
<!-- Form Actions -->
<div class="clv-actions">
<button class="btn btn-warning" onclick="resetCLVForm()" type="button">
<i class="fas fa-redo"></i> Reset Form
                    </button>
<button class="btn" onclick="saveCLVForm()" type="button">
<i class="fas fa-save"></i> Save Draft
                    </button>
<button class="btn btn-success" type="submit">
<i class="fas fa-check-circle"></i> Submit CLV
                    </button>
</div>
</form>
</div>
</div>
<!-- CLV Records Section -->
<div class="clv-tab-content" id="clvRecords">
<div class="clv-form-container">
<div class="clv-header">
<h2>CLV Records</h2>
<p>View and manage existing Child Learning Verification records</p>
</div>
<div class="search-box">
<input id="clvSearch" onkeyup="filterCLVRecords()" placeholder="🔍 Search CLV records..." type="text"/>
<select id="clvFilterStatus" onchange="filterCLVRecords()">
<option value="">All Statuses</option>
<option value="pending">Pending</option>
<option value="completed">Completed</option>
<option value="review">Under Review</option>
</select>
<select id="clvFilterSubject" onchange="filterCLVRecords()">
<option value="">All Subjects</option>
<option value="Quran">Quran Studies</option>
<option value="Arabic">Arabic Language</option>
<option value="Islamic">Islamic Studies</option>
<option value="Ethics">Islamic Ethics</option>
</select>
</div>
<div class="table-wrap">
<table class="clv-table">
<thead>
<tr>
<th>Student</th>
<th>Subject</th>
<th>Date</th>
<th>Topic</th>
<th>Level</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="clvTableBody">
<!-- CLV records will be populated dynamically -->
</tbody>
</table>
</div>
</div>
</div>
<!-- Original Teacher Management Section -->
<div class="clv-tab-content" id="teacherSection">
<div class="section">
<h3>➕ Add New Teacher</h3>
<label>Full Name</label>
<input id="teacherName" pattern="[A-Za-z\s\-']+" required="" title="Only letters, spaces, hyphens, and apostrophes are allowed." type="text"/>
<div class="error-message" id="teacherNameError">Please enter a valid name (letters, spaces, hyphens, apostrophes only).</div>
<label>Subject/Department</label>
<input id="teacherSubject" required="" type="text"/>
<div class="error-message" id="teacherSubjectError">Please enter a valid subject/department.</div>
<label>Phone Number</label>
<input id="teacherPhone" pattern="[0-9\s\-\+\(\)]+" required="" title="Only digits, spaces, hyphens, plus, and parentheses are allowed." type="tel"/>
<div class="error-message" id="teacherPhoneError">Please enter a valid phone number (digits, spaces, hyphens, plus, parentheses only).</div>
<label>Email Address</label>
<input id="teacherEmail" required="" type="email"/>
<div class="error-message" id="teacherEmailError">Please enter a valid email address.</div>
<label>Do you have a valid WWCC?</label>
<select id="teacherHasWwcc" onchange="toggleWwccForm()" required="">
<option value="">Select option</option>
<option value="yes">Yes</option>
<option value="no">No (Please contact management)</option>
</select>
<div class="error-message" id="teacherWwccError">Please select an option.</div>
<!-- WWCC Form (initially hidden) -->
<div id="wwccForm" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
<h4>WWCC Details</h4>
<label>Full name as it appears on the card</label>
<input id="wwccFullName" placeholder="Exactly as on WWCC card" type="text"/>
<label>Other names by which this person is known</label>
<input id="wwccOtherNames" placeholder="Nicknames, previous names, etc." type="text"/>
<label>Position in school</label>
<input id="wwccPosition" placeholder="e.g., Teacher, Assistant" type="text"/>
<label>Campus</label>
<input id="wwccCampus" readonly="" type="text" value="TAHA School - Dandenong"/>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div>
<label>WWCC Card Number</label>
<input id="wwccCardNumber" placeholder="WWCC number" type="text"/>
</div>
<div>
<label>Card Expiry Date</label>
<input id="wwccExpiryDate" type="date"/>
</div>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
<div>
<label>VIT Registration Number (if applicable)</label>
<input id="wwccVitNumber" placeholder="VIT registration number" type="text"/>
</div>
<div>
<label>VIT Registration Expiry Date</label>
<input id="wwccVitExpiry" type="date"/>
</div>
</div>
</div>
<button class="btn" onclick="addTeacher()"><i class="fas fa-plus"></i> Add Teacher</button>
<div class="section">
<h3> Teacher List</h3>
<div class="search-box">
<input id="teacherSearch" onkeyup="filterTeachers()" placeholder="🔍 Search teachers..." type="text"/>
</div>
<div class="table-wrap">
<table id="teacherTable">
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Subject</th>
<th>Phone</th>
<th>Email</th>
<th>WWCC</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="teacherTableBody">
<!-- Teacher data will be populated dynamically -->
</tbody>
</table>
</div>
</div>
<div class="section">
<h3>Teacher Attendance</h3>
<div class="search-box">
<select id="teacherAttendanceSelect" onchange="selectTeacherForAttendance()">
<option value="">Select Teacher</option>
<!-- Teachers will be populated dynamically -->
</select>
</div>
<div id="teacherAttendanceCalendar"></div>
<button class="btn btn-success" onclick="saveTeacherAttendanceData()" style="margin-top: 20px;"><i class="fas fa-save"></i> Save Attendance</button>
</div>
</div>
</div>
</div>
<!-- Fee Management Tab -->
<div class="tab-content" id="feeTab">
<h2>Fee Management</h2>
<div class="section">
<h3> Fee Records</h3>
<div class="search-box">
<input id="feeSearch" onkeyup="filterFeeStudents()" placeholder="🔍 Search students by name or ID..." type="text"/>
<button class="btn btn-success" onclick="generateFeeReport()"><i class="fas fa-file-invoice"></i> Generate Report</button>
</div>
<div class="table-wrap">
<table id="feeStudentTable">
<thead>
<tr>
<th>ID</th>
<th>Student Name</th>
<th>Grade</th>
<th>Parent Name</th>
<th>Balance</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="feeStudentTableBody"></tbody>
</table>
</div>
</div>
<div class="section">
<h3> Add Fee Records</h3>
<div id="feeEntriesContainer"></div>
<button class="btn" onclick="addFeeEntry()"><i class="fas fa-plus"></i> Add Fee Entry</button>
<button class="btn btn-success" onclick="saveFeeRecords()"><i class="fas fa-save"></i> Save Fee Records</button>
</div>
</div>
<!-- Reports Tab -->
<div class="tab-content" id="reportsTab">
<h2>Reports &amp; Analytics</h2>
<div class="stats-section">
<div class="stats-card">
<i class="fas fa-users"></i>
<div class="value" id="totalStudents">0</div>
<div class="label">Total Students</div>
</div>
<div class="stats-card">
<i class="fas fa-chalkboard-teacher"></i>
<div class="value" id="totalTeachers">0</div>
<div class="label">Total Teachers</div>
</div>
<div class="stats-card">
<i class="fas fa-dollar-sign"></i>
<div class="value" id="totalFeesCollected">0</div>
<div class="label">Total Fees Collected</div>
</div>
<div class="stats-card">
<i class="fas fa-chart-line"></i>
<div class="value" id="attendanceRate">0%</div>
<div class="label">Average Attendance</div>
</div>
</div>
<div class="section">
<h3> Fee Collection Chart</h3>
<canvas height="200" id="feeChart" width="400"></canvas>
</div>
<div class="section">
<h3> Student Attendance Chart</h3>
<canvas height="200" id="studentAttendanceChart" width="400"></canvas>
</div>
<div class="section">
<h3>Teacher Attendance Chart</h3>
<canvas height="200" id="teacherAttendanceChart" width="400"></canvas>
</div>
</div>
<!-- Add this section to the Reports tab -->
<div class="section">
    <h3> Export & Import Data</h3>
    <div class="action-buttons">
        <!-- Export Buttons -->
        <div style="margin-bottom: 15px;">
            <h4>Export Reports</h4>
            <div class="action-buttons">
                           <button class="btn btn-info" onclick="exportStudentReport('pdf')"><i class="fas fa-file-pdf"></i> Export Students (PDF)</button>
                                <button class="btn btn-info" onclick="exportFeeReport('pdf')"><i class="fas fa-file-pdf"></i> Export Fees (PDF)</button>
            </div>
        </div>
        
       
<!-- Modals -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModals()"></div>
<div class="modal" id="studentDetailsModal">
<div class="modal-header">
<h3>Student Details</h3>
<button class="btn" onclick="closeModals()">×</button>
</div>
<div id="studentDetailsContent"></div>
<div class="action-buttons">
<button class="btn btn-info" onclick="showPrintPreview('studentDetails')"><i class="fas fa-print"></i> Print</button>
<button class="btn btn-warning" onclick="editStudent()"><i class="fas fa-edit"></i> Edit</button>
<button class="btn" onclick="closeModals()">Close</button>
</div>
</div>
<div class="modal" id="teacherDetailsModal">
<div class="modal-header">
<h3>Teacher Details</h3>
<button class="btn" onclick="closeModals()">×</button>
</div>
<div id="teacherDetailsContent"></div>
<div class="action-buttons">
<button class="btn btn-info" onclick="showPrintPreview('teacherDetails')"><i class="fas fa-print"></i> Print</button>
<button class="btn" onclick="closeModals()">Close</button>
</div>
</div>
<div class="modal" id="feeReportSection">
<div class="modal-header">
<h3>All Fees Report</h3>
<button class="btn" onclick="closeModals()">×</button>
</div>
<div id="feeReportContent"></div>
<div class="action-buttons">
<button class="btn btn-info" onclick="showPrintPreview('feeReport')"><i class="fas fa-print"></i> Print</button>
<button class="btn" onclick="closeModals()">Close</button>
</div>
</div>
<div class="modal" id="monthlyFeeReportModal">
<div class="modal-header">
<h3>Monthly Fees Report</h3>
<button class="btn" onclick="closeModals()">×</button>
</div>
<div id="monthlyFeeReportContent"></div>
<div class="action-buttons">
<button class="btn btn-info" onclick="showPrintPreview('monthlyFeeReport')"><i class="fas fa-print"></i> Print</button>
<button class="btn" onclick="closeModals()">Close</button>
</div>
</div>
<div class="modal" id="individualFeeReportModal">
<div class="modal-header">
<h3>Individual Fee Report</h3>
<button class="btn" onclick="closeModals()">×</button>
</div>
<div id="individualFeeReportContent"></div>
<div class="action-buttons">
<button class="btn btn-info" onclick="showPrintPreview('individualFeeReport')"><i class="fas fa-print"></i> Print</button>
<button class="btn" onclick="closeModals()">Close</button>
</div>
</div>
<div class="modal" id="printPreviewModal">
<div class="modal-header">
<h3><i class="fas fa-file-alt"></i> Print Preview</h3>
<button class="btn" onclick="closePrintPreview()">×</button>
</div>
<div id="printPreviewContent"></div>
<div class="action-buttons">
<button class="btn btn-success" onclick="executePrint()" style="margin-top: 20px;"><i class="fas fa-print"></i> Print</button>
<button class="btn" onclick="closePrintPreview()">Close</button>
</div>
</div>
<div class="toast" id="toast">
<i class="fas fa-info-circle"></i>
<span id="toast-message"></span>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
        // Data Storage (Using localStorage for persistence)
        const STUDENT_DB_FILE = 'studentDatabase';
        const TEACHER_DB_FILE = 'teacherDatabase';
        const ATTENDANCE_FILE = 'attendanceData';
        const TEACHER_ATTENDANCE_FILE = 'teacherAttendanceData';
        const FEE_RECORDS_FILE = 'feeRecords';
        const CLV_RECORDS_FILE = 'clvRecords'; // Added for CLV records
        let studentDatabase = JSON.parse(localStorage.getItem(STUDENT_DB_FILE)) || [];
        let teacherDatabase = JSON.parse(localStorage.getItem(TEACHER_DB_FILE)) || [];
        let attendanceData = JSON.parse(localStorage.getItem(ATTENDANCE_FILE)) || {};
        let teacherAttendanceData = JSON.parse(localStorage.getItem(TEACHER_ATTENDANCE_FILE)) || {};
        let feeRecords = JSON.parse(localStorage.getItem(FEE_RECORDS_FILE)) || {};
        let clvRecords = JSON.parse(localStorage.getItem(CLV_RECORDS_FILE)) || []; // Added for CLV records
        let nextStudentId = parseInt(localStorage.getItem('nextStudentId')) || 1;
        let nextTeacherId = parseInt(localStorage.getItem('nextTeacherId')) || 1;
        let currentAttendanceView = {
            studentId: null,
            year: new Date().getFullYear(),
            month: new Date().getMonth()
        };
        let currentTeacherAttendanceView = {
            teacherId: null,
            year: new Date().getFullYear(),
            month: new Date().getMonth()
        };
        let editingStudentId = null;
        let availableChildIds = []; // Track available child IDs that can be reused
        // School Information
        const schoolName = "Taha Association School";
        const schoolAddress = "9-11 Patrona st, Dandenong VIC 3175";
        const schoolABN = "ABN: 12 345 678 901";
        const schoolLogo = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMDAiIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzVBQzhGQSIvPjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjQwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+VEFTPC90ZXh0Pjwvc3ZnPg==";
        // DOM Elements
       document.addEventListener('DOMContentLoaded', function () {
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTabId = tab.getAttribute('data-tab');
            
            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Show target content
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === targetTabId) {
                    content.classList.add('active');
                }
            });
            
            // Update UI based on tab
            if (targetTabId === 'databaseTab') {
                updateDatabaseView();
            }
            if (targetTabId === 'teacherTab') {
                updateTeacherView();
                populateTeacherAttendanceSelect();
                loadCLVRecords();
            }
            if (targetTabId === 'reportsTab') {
                updateReports();
                renderFeeChart();
                renderStudentAttendanceChart();
                renderTeacherAttendanceChart();
            }
            if (targetTabId === 'feeTab') {
                updateFeeStudentTable();
            }
            if (targetTabId === 'attendanceTab') {
                renderStudentList();
                renderAttendanceCalendar();
            }
        });
    });
    
    // Initialize the app
    initializeApp();
});
        // Initialize App
        async function initializeApp() {
            // Load data from localStorage
            loadDataFromStorage();
            
            // Update UI
            updateDatabaseView();
            updateTeacherView();
            updateFeeStudentTable();
            populateYearSelect();
            populateTeacherYearSelect();
            renderAttendanceCalendar();
            renderTeacherAttendanceCalendar();
            updateReports();
            renderFeeChart();
            renderStudentAttendanceChart();
            renderTeacherAttendanceChart();
            renderStudentList();
            setupIOSClock();
            
            // Add validation event listeners to teacher form inputs
            const teacherInputs = document.querySelectorAll('#teacherName, #teacherPhone, #teacherEmail, #teacherHasWwcc');
            teacherInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateTeacherInput(this);
                });
            });
        }
        // Load Data from Storage
        function loadDataFromStorage() {
            studentDatabase = JSON.parse(localStorage.getItem(STUDENT_DB_FILE)) || [];
			 feeRecords = JSON.parse(localStorage.getItem(FEE_RECORDS_FILE)) || [];
            teacherDatabase = JSON.parse(localStorage.getItem(TEACHER_DB_FILE)) || [];
            attendanceData = JSON.parse(localStorage.getItem(ATTENDANCE_FILE)) || {};
            teacherAttendanceData = JSON.parse(localStorage.getItem(TEACHER_ATTENDANCE_FILE)) || {};
            feeRecords = JSON.parse(localStorage.getItem(FEE_RECORDS_FILE)) || [];
            clvRecords = JSON.parse(localStorage.getItem(CLV_RECORDS_FILE)) || []; // Load CLV records
            nextStudentId = parseInt(localStorage.getItem('nextStudentId')) || 1;
            nextTeacherId = parseInt(localStorage.getItem('nextTeacherId')) || 1;
            
            // Initialize availableChildIds with all possible IDs from nextStudentId down to 1
            availableChildIds = Array.from({length: nextStudentId}, (_, i) => i + 1);
            
            // Remove IDs that are currently in use
            studentDatabase.forEach(student => {
                const match = student.studentId.match(/TAS-(\d+)/);
                if (match) {
                    const idNum = parseInt(match[1]);
                    const index = availableChildIds.indexOf(idNum);
                    if (index !== -1) {
                        availableChildIds.splice(index, 1);
                    }
                }
            });
        }
        // Save Data to Storage
        async function saveDataToFiles() {
            try {
                localStorage.setItem(STUDENT_DB_FILE, JSON.stringify(studentDatabase));
                localStorage.setItem(TEACHER_DB_FILE, JSON.stringify(teacherDatabase));
                localStorage.setItem(ATTENDANCE_FILE, JSON.stringify(attendanceData));
                localStorage.setItem(TEACHER_ATTENDANCE_FILE, JSON.stringify(teacherAttendanceData));
                localStorage.setItem(FEE_RECORDS_FILE, JSON.stringify(feeRecords));
                localStorage.setItem(CLV_RECORDS_FILE, JSON.stringify(clvRecords)); // Save CLV records
                localStorage.setItem('nextStudentId', nextStudentId.toString());
                localStorage.setItem('nextTeacherId', nextTeacherId.toString());
                console.log("All data saved successfully.");
                showToast("All data saved successfully!", "success");
            } catch (error) {
                console.error("Failed to save data to localStorage:", error);
                showToast("Failed to save data. Please try again.", "error");
            }
        }
        // Validation Functions
        function validateInput(inputId, errorId, validationFn, errorMsg) {
            const input = document.getElementById(inputId);
            const error = document.getElementById(errorId);
            if (!validationFn(input.value)) {
                input.classList.add('error');
                error.textContent = errorMsg;
                error.classList.add('show');
                return false;
            } else {
                input.classList.remove('error');
                error.classList.remove('show');
                return true;
            }
        }
        function validateName(name) {
            return /^[A-Za-z\s\-']+$/.test(name) && name.trim().length > 0;
        }
        function validatePhone(phone) {
            return /^[0-9\s\-\+\(\)]+$/.test(phone) && phone.trim().length > 0;
        }
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        function validateRequired(value) {
            return value.trim().length > 0;
        }
        function validateParentInput(input) {
            const errorMsg = input.nextElementSibling;
            let isValid = true;
            if (input.id === 'parentName') {
                if (validateName(input.value)) {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            } else if (input.id === 'parentPhone') {
                if (validatePhone(input.value)) {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            } else if (input.id === 'parentEmail') {
                if (validateEmail(input.value)) {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            }
        }
        function validateTeacherInput(input) {
            const errorMsg = input.nextElementSibling;
            let isValid = true;
            if (input.id === 'teacherName') {
                if (validateName(input.value)) {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            } else if (input.id === 'teacherPhone') {
                if (validatePhone(input.value)) {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            } else if (input.id === 'teacherEmail') {
                if (validateEmail(input.value)) {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            } else if (input.id === 'teacherHasWwcc') {
                if (input.value !== '') {
                    input.classList.remove('error');
                    errorMsg.classList.remove('show');
                } else {
                    input.classList.add('error');
                    errorMsg.classList.add('show');
                }
            }
        }
        // Registration Functions
        function addChildForm() {
            const container = document.getElementById('childrenContainer');
            const childCount = container.children.length + 1;
            
            // Get the next available ID (either from availableChildIds or nextStudentId)
            let newStudentIdNumber;
            if (availableChildIds.length > 0) {
                // Reuse an available ID
                newStudentIdNumber = availableChildIds.shift();
            } else {
                // Use the next new ID
                newStudentIdNumber = nextStudentId++;
            }
            
            const newStudentId = `TAS-${String(newStudentIdNumber).padStart(5, '0')}`;
            
            const childDiv = document.createElement('div');
            childDiv.className = 'child-section';
            childDiv.dataset.childId = newStudentIdNumber; // Store the ID number for tracking
            
            childDiv.innerHTML = `
                <h4>Child #${childCount} 
                    <button type="button" class="btn btn-danger" onclick="removeChild(this)" style="float:right; padding: 5px 10px;">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </h4>
                <label>Student ID</label>
                <input type="text" class="studentId" value="${newStudentId}" readonly>
                
                <label>Full Name</label>
                <input type="text" class="studentName" required pattern="[A-Za-z\s\-']+" title="Only letters, spaces, hyphens, and apostrophes are allowed.">
                <div class="error-message">Please enter a valid name (letters, spaces, hyphens, apostrophes only).</div>
                
                <label>Date of Birth</label>
                <input type="date" class="studentDob" required>
                <div class="error-message">Please enter a valid date of birth.</div>
                
                <label>Grade/Class</label>
                <input type="text" class="grade" required>
                <div class="error-message">Please enter a valid grade/class.</div>
                
                <label>Current School</label>
                <input type="text" class="currentSchool" required>
                <div class="error-message">Please enter the current school name.</div>
            `;
            
            container.appendChild(childDiv);
            
            // Set today's date as default for DOB
            const today = new Date().toISOString().split('T')[0];
            childDiv.querySelector('.studentDob').value = today;
            
            // Add validation event listeners to the new inputs
            const inputs = childDiv.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    validateChildInput(this);
                });
            });
        }
        function validateChildInput(input) {
            const errorMsg = input.nextElementSibling;
            let isValid = true;
            // Check if this is the Grade/Class field - allow any character if not empty
            if (input.classList.contains('grade')) {
                isValid = input.value.trim().length > 0;
            } else if (input.classList.contains('studentName')) {
                isValid = validateName(input.value);
            } else if (input.classList.contains('studentDob')) {
                isValid = input.value !== '';
            } else if (input.classList.contains('currentSchool')) {
                isValid = input.value.trim().length > 0;
            }
            if (isValid) {
                input.classList.remove('error');
                errorMsg.classList.remove('show');
            } else {
                input.classList.add('error');
                errorMsg.classList.add('show');
            }
            return isValid;
        }
        function removeChild(button) {
            const childDiv = button.closest('.child-section');
            const childId = parseInt(childDiv.dataset.childId);
            
            // Add the ID back to availableChildIds if it's not the next ID in sequence
            if (childId < nextStudentId - 1) {
                availableChildIds.push(childId);
                availableChildIds.sort((a, b) => a - b); // Keep sorted for easy management
            }
            
            childDiv.remove();
            
            // Renumber remaining children
            const container = document.getElementById('childrenContainer');
            const children = container.querySelectorAll('.child-section');
            children.forEach((child, index) => {
                child.querySelector('h4').innerHTML = `Child #${index + 1} 
                    <button type="button" class="btn btn-danger" onclick="removeChild(this)" style="float:right; padding: 5px 10px;">
                        <i class="fas fa-trash"></i> Remove
                    </button>`;
            });
        }
        function clearForm() {
            if (confirm('Are you sure you want to clear the entire form?')) {
                document.getElementById('registrationForm').reset();
                const container = document.getElementById('childrenContainer');
                
                // Return all child IDs to availableChildIds
                const children = container.querySelectorAll('.child-section');
                children.forEach(child => {
                    const childId = parseInt(child.dataset.childId);
                    if (childId < nextStudentId - 1) {
                        availableChildIds.push(childId);
                    }
                });
                
                container.innerHTML = '';
                
                // Reset validation errors
                const errorElements = document.querySelectorAll('.error');
                errorElements.forEach(el => el.classList.remove('error'));
                
                const errorMessages = document.querySelectorAll('.error-message.show');
                errorMessages.forEach(el => el.classList.remove('show'));
                
                // Reset editing mode
                editingStudentId = null;
                
                showToast('Form cleared successfully!', 'success');
            }
        }
        async function saveRegistration() {
            // Validate parent form
            let isValid = true;
            isValid = validateInput('parentName', 'parentNameError', validateName, 'Please enter a valid name (letters, spaces, hyphens, apostrophes only).') && isValid;
            isValid = validateInput('relationship', 'relationshipError', validateRequired, 'Please enter a valid relationship.') && isValid;
            isValid = validateInput('parentPhone', 'parentPhoneError', validatePhone, 'Please enter a valid phone number (digits, spaces, hyphens, plus, parentheses only).') && isValid;
            isValid = validateInput('parentEmail', 'parentEmailError', validateEmail, 'Please enter a valid email address.') && isValid;
            // Validate child forms
            const childSections = document.querySelectorAll('.child-section');
            if (childSections.length === 0) {
                showToast('Please add at least one child', 'warning');
                return;
            }
            childSections.forEach(section => {
                const inputs = section.querySelectorAll('input');
                inputs.forEach(input => {
                    if (!validateChildInput(input)) {
                        isValid = false;
                    }
                });
            });
            if (!isValid) {
                showToast('Please fix the errors in the form before saving.', 'error');
                return;
            }
            // Collect data from the form
            const parentData = {
                name: document.getElementById('parentName').value,
                relationship: document.getElementById('relationship').value,
                phone: document.getElementById('parentPhone').value,
                email: document.getElementById('parentEmail').value
            };
            const children = [];
            childSections.forEach(section => {
                const childData = {
                    studentId: section.querySelector('.studentId').value,
                    name: section.querySelector('.studentName').value,
                    dob: section.querySelector('.studentDob').value,
                    grade: section.querySelector('.grade').value,
                    currentSchool: section.querySelector('.currentSchool').value
                };
                children.push(childData);
            });
            try {
                if (editingStudentId) {
                    // Update existing student record
                    const studentIndex = studentDatabase.findIndex(s => s.id === editingStudentId);
                    if (studentIndex !== -1) {
                        studentDatabase[studentIndex].parent = parentData;
                        studentDatabase[studentIndex].student = children[0]; // Assuming one child for edit
                        showToast('Student record updated successfully!', 'success');
                    }
                    editingStudentId = null;
                } else {
                    // Add new children to student database
                    children.forEach((childData, index) => {
                        const studentRecord = {
                            id: Date.now() + Math.random() + index,
                            studentId: childData.studentId,
                            parent: parentData,
                            student: childData
                        };
                        studentDatabase.push(studentRecord);
                        // Initialize attendance data for the new student
                        if (!attendanceData[studentRecord.id]) {
                            attendanceData[studentRecord.id] = {};
                            // Initialize with empty arrays for each year/month if needed for your structure
                            const currentYear = new Date().getFullYear();
                            for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                                attendanceData[studentRecord.id][y] = {};
                                for (let m = 0; m < 12; m++) {
                                    attendanceData[studentRecord.id][y][m] = Array(getDaysInMonth(y, m)).fill(null);
                                }
                            }
                        }
                        // Initialize fee records for the new student
                        if (!feeRecords[studentRecord.id]) {
                            feeRecords[studentRecord.id] = [];
                        }
                    });
                    // Update nextStudentId based on the highest ID used in this registration
                    const highestIdInNewChildren = Math.max(...children.map(c => {
                        const match = c.studentId.match(/TAS-(\d+)/);
                        return match ? parseInt(match[1], 10) : 0;
                    }));
                    if (highestIdInNewChildren >= nextStudentId) {
                        nextStudentId = highestIdInNewChildren + 1;
                    }
                    showToast('Registration saved successfully!', 'success');
                }
                // Save data to files
                await saveDataToFiles();
                // Update UI elements
                updateDatabaseView();
                updateReports();
                updateFeeStudentTable();
                renderStudentList();
                // Reset form
                document.getElementById('registrationForm').reset();
                document.getElementById('childrenContainer').innerHTML = '';
                
                // Clear availableChildIds as all IDs are now in use
                availableChildIds = [];
            } catch (error) {
                console.error('Error saving registration:', error);
                showToast('Failed to save registration. Please try again.', 'error');
            }
        }
        // Database Functions
        function updateDatabaseView() {
            const tbody = document.getElementById('databaseTableBody');
            tbody.innerHTML = '';
            studentDatabase.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.studentId}</td>
                    <td>${record.student.name}</td>
                    <td>${record.student.grade}</td>
                    <td>${record.parent.name}</td>
                    <td>${record.parent.phone}</td>
                    <td>${record.parent.email}</td>
                    <td>
                        <button class="btn" onclick='viewStudentDetails(${record.id})'><i class="fas fa-eye"></i> View</button>
                        <button class="btn btn-warning" onclick='editStudentRecord(${record.id})'><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger" onclick='deleteStudent(${record.id})'><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function filterDatabase() {
            const searchTerm = document.getElementById('databaseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#databaseTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        function viewStudentDetails(studentId) {
            const student = studentDatabase.find(s => s.id == studentId);
            if (!student) return;
            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Student Information</h4>
                        <p><strong>Student ID:</strong> ${student.studentId}</p>
                        <p><strong>Name:</strong> ${student.student.name}</p>
                        <p><strong>Date of Birth:</strong> ${student.student.dob}</p>
                        <p><strong>Grade:</strong> ${student.student.grade}</p>
                        <p><strong>Current School:</strong> ${student.student.currentSchool}</p>
                    </div>
                    <div>
                        <h4>Parent/Guardian Information</h4>
                        <p><strong>Name:</strong> ${student.parent.name}</p>
                        <p><strong>Relationship:</strong> ${student.parent.relationship}</p>
                        <p><strong>Phone:</strong> ${student.parent.phone}</p>
                        <p><strong>Email:</strong> ${student.parent.email}</p>
                    </div>
                </div>
            `;
            document.getElementById('studentDetailsContent').innerHTML = html;
            document.getElementById('studentDetailsModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }
        function editStudentRecord(studentId) {
            const student = studentDatabase.find(s => s.id == studentId);
            if (!student) return;
            // Set editing mode
            editingStudentId = studentId;
            // Fill the form with student data
            document.getElementById('parentName').value = student.parent.name;
            document.getElementById('relationship').value = student.parent.relationship;
            document.getElementById('parentPhone').value = student.parent.phone;
            document.getElementById('parentEmail').value = student.parent.email;
            // Clear existing children
            document.getElementById('childrenContainer').innerHTML = '';
            // Add child section with student data
            const container = document.getElementById('childrenContainer');
            const childDiv = document.createElement('div');
            childDiv.className = 'child-section';
            
            // Extract student ID number
            const match = student.studentId.match(/TAS-(\d+)/);
            const studentIdNum = match ? parseInt(match[1]) : nextStudentId;
            
            childDiv.dataset.childId = studentIdNum;
            
            childDiv.innerHTML = `
                <h4>Child #1 
                    <button type="button" class="btn btn-danger" onclick="removeChild(this)" style="float:right; padding: 5px 10px;">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </h4>
                <label>Student ID</label>
                <input type="text" class="studentId" value="${student.studentId}" readonly>
                
                <label>Full Name</label>
                <input type="text" class="studentName" value="${student.student.name}" required pattern="[A-Za-z\s\-']+" title="Only letters, spaces, hyphens, and apostrophes are allowed.">
                <div class="error-message">Please enter a valid name (letters, spaces, hyphens, apostrophes only).</div>
                
                <label>Date of Birth</label>
                <input type="date" class="studentDob" value="${student.student.dob}" required>
                <div class="error-message">Please enter a valid date of birth.</div>
                
                <label>Grade/Class</label>
                <input type="text" class="grade" value="${student.student.grade}" required>
                <div class="error-message">Please enter a valid grade/class.</div>
                
                <label>Current School</label>
                <input type="text" class="currentSchool" value="${student.student.currentSchool}" required>
                <div class="error-message">Please enter a valid current school.</div>
            `;
            
            container.appendChild(childDiv);
            
            // Add validation event listeners to the new inputs
            const inputs = childDiv.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    validateChildInput(this);
                });
            });
            // Switch to registration tab
            document.querySelector('.tab[data-tab="formTab"]').click();
            
            // Close modal
            closeModals();
            
            showToast('Editing student record. Make changes and save.', 'info');
        }
        function editStudent() {
            // This function is called from the modal
            const studentDetailsContent = document.getElementById('studentDetailsContent').innerHTML;
            // Extract student ID from the content (this is a simplified approach)
            const studentIdMatch = studentDetailsContent.match(/Student ID:<\/strong> TAS-(\d+)/);
            if (studentIdMatch) {
                const studentId = parseInt(studentIdMatch[1]);
                editStudentRecord(studentId);
            }
        }
        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student record?')) {
                // Filter out the student to be deleted
                const studentToDelete = studentDatabase.find(s => s.id == studentId);
                studentDatabase = studentDatabase.filter(s => s.id != studentId);
                
                // Remove associated data
                delete attendanceData[studentId]; // Remove attendance data
                delete feeRecords[studentId]; // Remove fee records
                
                // Add the student ID back to availableChildIds if it's not the next ID in sequence
                if (studentToDelete) {
                    const match = studentToDelete.studentId.match(/TAS-(\d+)/);
                    if (match) {
                        const idNum = parseInt(match[1]);
                        if (idNum < nextStudentId - 1) {
                            availableChildIds.push(idNum);
                            availableChildIds.sort((a, b) => a - b); // Keep sorted
                        }
                    }
                }
                
                // Recalculate nextStudentId based on remaining students
                if (studentDatabase.length > 0) {
                    const studentIds = studentDatabase.map(s => {
                        const match = s.studentId.match(/TAS-(\d+)/);
                        return match ? parseInt(match[1], 10) : 0;
                    });
                    nextStudentId = Math.max(...studentIds) + 1;
                } else {
                    nextStudentId = 1;
                }
                
                // Update UI elements
                updateDatabaseView();
                updateReports();
                updateFeeStudentTable();
                renderStudentList(); // Update student list in attendance tab
                
                // Save data to files (including the updated nextStudentId)
                await saveDataToFiles();
                
                showToast('Student record deleted successfully!', 'success');
            }
        }
        // Export and Import Functions
        async function exportStudentData(format) {
            try {
                if (!format) {
                    format = prompt("Enter export format (excel/pdf/csv/json):", "excel")?.toLowerCase();
                    if (!format) return; // User canceled
                }
                // Show loading indicator
                showToast('Preparing export...', 'info');
                
                // Give UI time to update
                await new Promise(resolve => setTimeout(resolve, 100));
                switch (format) {
                    case "json":
                        await exportToJSON();
                        break;
                    case "csv":
                        await exportToCSV();
                        break;
                    case "pdf":
                        await exportToPDF();
                        break;
                    case "excel":
                        await exportToExcel();
                        break;
                    default:
                        showToast('Invalid format. Please enter excel, pdf, csv, or json.', 'error');
                        return;
                }
            } catch (error) {
                console.error("Export error:", error);
                showToast(`Export failed: ${error.message}`, 'error');
            }
        }
        // Individual export functions
        async function exportToJSON() {
            const dataStr = JSON.stringify(studentDatabase, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'taha_student_data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showToast('JSON export complete!', 'success');
        }
        async function exportToCSV() {
            const headers = [
                'ID', 'Student Name', 'Date of Birth', 'Grade',
                'Current School', 'Parent Name', 'Relationship',
                'Parent Phone', 'Parent Email'
            ];
            
            const rows = studentDatabase.map(record => [
                record.studentId,
                `"${record.student.name.replace(/"/g, '""')}"`,
                record.student.dob,
                `"${record.student.grade.replace(/"/g, '""')}"`,
                `"${record.student.currentSchool.replace(/"/g, '""')}"`,
                `"${record.parent.name.replace(/"/g, '""')}"`,
                `"${record.parent.relationship.replace(/"/g, '""')}"`,
                record.parent.phone,
                record.parent.email
            ]);
            
            const csvContent = [headers, ...rows]
                .map(row => row.join(','))
                .join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'taha_student_data.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showToast('CSV export complete!', 'success');
        }
        async function exportToPDF() {
            try {
                // Check if jsPDF is properly initialized
                if (typeof jsPDF === 'undefined') {
                    // Try to initialize if not available
                    if (typeof window.jspdf !== 'undefined') {
                        window.jsPDF = window.jspdf.jsPDF;
                    } else {
                        throw new Error('PDF library not loaded. Please refresh the page.');
                    }
                }
                // Create new PDF document
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm'
                });
                // Add header
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(40);
                doc.text('TAHA School - Student Report', 
                        doc.internal.pageSize.width / 2, 
                        15, 
                        { align: 'center' });
                // Add current date
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 
                        doc.internal.pageSize.width - 10, 
                        10, 
                        { align: 'right' });
                // Prepare data
                const headers = [
                    'ID',
                    'Student Name',
                    'Grade',
                    'Parent Name', 
                    'Parent Phone',
                    'Parent Email'
                ];
                
                const data = studentDatabase.map(record => [
                    record.studentId,
                    record.student.name,
                    record.student.grade,
                    record.parent.name,
                    record.parent.phone,
                    record.parent.email
                ]);
                // Create table
                doc.autoTable({
                    startY: 25,
                    head: [headers],
                    body: data,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [67, 97, 238],
                        textColor: 255,
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240]
                    },
                    margin: { top: 25 },
                    styles: {
                        fontSize: 9,
                        cellPadding: 3,
                        overflow: 'linebreak'
                    }
                });
                // Save the PDF
                doc.save('taha_student_data.pdf');
                showToast('PDF export complete!', 'success');
                
            } catch (error) {
                console.error("PDF export error:", error);
                showToast(`PDF export failed: ${error.message}`, 'error');
                
                // If library failed to load, try loading it dynamically
                if (error.message.includes('not loaded')) {
                    await loadPDFLibrary();
                    // Retry after loading
                    await exportToPDF();
                }
            }
        }
        // Helper function to dynamically load PDF libraries if missing
        function loadPDFLibrary() {
            return new Promise((resolve, reject) => {
                if (typeof jsPDF !== 'undefined') {
                    resolve();
                    return;
                }
                const scripts = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js'
                ];
                let loaded = 0;
                
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        loaded++;
                        if (loaded === scripts.length) {
                            window.jsPDF = window.jspdf.jsPDF;
                            resolve();
                        }
                    };
                    script.onerror = () => reject(new Error('Failed to load PDF library'));
                    document.head.appendChild(script);
                });
            });
        }
        async function exportToExcel() {
            try {
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined' || !XLSX.utils || !XLSX.utils.book_new) {
                    throw new Error('Excel export library not loaded. Please refresh the page.');
                }
                const headers = [
                    'ID', 'Student Name', 'Date of Birth', 'Grade',
                    'Current School', 'Parent Name', 'Relationship',
                    'Parent Phone', 'Parent Email'
                ];
                
                const data = studentDatabase.map(record => [
                    record.studentId,
                    record.student.name,
                    record.student.dob,
                    record.student.grade,
                    record.student.currentSchool,
                    record.parent.name,
                    record.parent.relationship,
                    record.parent.phone,
                    record.parent.email
                ]);
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                XLSX.utils.book_append_sheet(wb, ws, "Students");
                
                // Export to Excel
                XLSX.writeFile(wb, 'taha_student_data.xlsx');
                showToast('Excel export complete!', 'success');
            } catch (error) {
                console.error("Excel export error:", error);
                showToast(`Excel export failed: ${error.message}`, 'error');
                
                // If library failed to load, try loading it dynamically
                if (error.message.includes('not loaded')) {
                    await loadSheetJS();
                    // Retry after loading
                    await exportToExcel();
                }
            }
        }
        // Helper function to dynamically load SheetJS if missing
        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (typeof XLSX !== 'undefined') {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load Excel export library'));
                document.head.appendChild(script);
            });
        }
        function importStudentData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    let importedData = [];
                    let duplicatesFound = 0;
                    let newRecords = 0;
                    
                    if (file.name.endsWith('.json')) {
                        importedData = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        // Simple CSV parser (doesn't handle quoted fields with commas)
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim() === '') continue;
                            const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            const record = {};
                            for (let j = 0; j < headers.length; j++) {
                                if (headers[j] === 'ID') {
                                    record.studentId = values[j];
                                } else if (headers[j] === 'Student Name') {
                                    if (!record.student) record.student = {};
                                    record.student.name = values[j];
                                } else if (headers[j] === 'Date of Birth') {
                                    if (!record.student) record.student = {};
                                    record.student.dob = values[j];
                                } else if (headers[j] === 'Grade') {
                                    if (!record.student) record.student = {};
                                    record.student.grade = values[j];
                                } else if (headers[j] === 'Current School') {
                                    if (!record.student) record.student = {};
                                    record.student.currentSchool = values[j];
                                } else if (headers[j] === 'Parent Name') {
                                    if (!record.parent) record.parent = {};
                                    record.parent.name = values[j];
                                } else if (headers[j] === 'Relationship') {
                                    if (!record.parent) record.parent = {};
                                    record.parent.relationship = values[j];
                                } else if (headers[j] === 'Parent Phone') {
                                    if (!record.parent) record.parent = {};
                                    record.parent.phone = values[j];
                                } else if (headers[j] === 'Parent Email') {
                                    if (!record.parent) record.parent = {};
                                    record.parent.email = values[j];
                                }
                            }
                            // Generate ID for the record
                            record.id = Date.now() + Math.random();
                            importedData.push(record);
                        }
                    } else if (file.name.endsWith('.xlsx')) {
                        // Handle Excel import
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        jsonData.forEach(row => {
                            const record = {
                                id: Date.now() + Math.random(),
                                studentId: row['ID'] || '',
                                student: {
                                    name: row['Student Name'] || '',
                                    dob: row['Date of Birth'] || '',
                                    grade: row['Grade'] || '',
                                    currentSchool: row['Current School'] || ''
                                },
                                parent: {
                                    name: row['Parent Name'] || '',
                                    relationship: row['Relationship'] || '',
                                    phone: row['Parent Phone'] || '',
                                    email: row['Parent Email'] || ''
                                }
                            };
                            importedData.push(record);
                        });
                    } else {
                        showToast('Unsupported file format. Please use JSON, CSV, or Excel.', 'error');
                        return;
                    }
                    // Validate data structure
                    const isValid = Array.isArray(importedData) && importedData.every(record =>
                        record.studentId &&
                        record.student &&
                        record.student.name &&
                        record.parent &&
                        record.parent.name
                    );
                    if (isValid) {
                        // Check for duplicates and add new records
                        const existingIds = studentDatabase.map(s => s.studentId);
                        const newRecordsList = [];
                        
                        importedData.forEach(record => {
                            if (existingIds.includes(record.studentId)) {
                                duplicatesFound++;
                            } else {
                                newRecordsList.push(record);
                                existingIds.push(record.studentId); // Add to existing to prevent duplicates in same import
                            }
                        });
                        if (newRecordsList.length > 0) {
                            studentDatabase = [...studentDatabase, ...newRecordsList];
                            
                            // Initialize data structures for new students
                            newRecordsList.forEach(record => {
                                if (!attendanceData[record.id]) {
                                    attendanceData[record.id] = {};
                                    const currentYear = new Date().getFullYear();
                                    for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                                        attendanceData[record.id][y] = {};
                                        for (let m = 0; m < 12; m++) {
                                            attendanceData[record.id][y][m] = Array(getDaysInMonth(y, m)).fill(null);
                                        }
                                    }
                                }
                                if (!feeRecords[record.id]) {
                                    feeRecords[record.id] = [];
                                }
                            });
                            // Update nextStudentId based on imported records
                            const highestId = Math.max(...studentDatabase.map(s => {
                                const match = s.studentId.match(/TAS-(\d+)/);
                                return match ? parseInt(match[1], 10) : 0;
                            }));
                            if (highestId >= nextStudentId) {
                                nextStudentId = highestId + 1;
                            }
                            
                            // Reset availableChildIds as all IDs are now in use
                            availableChildIds = [];
                            updateDatabaseView();
                            updateReports();
                            renderStudentList();
                            await saveDataToFiles();
                            
                            let message = `Successfully imported ${newRecordsList.length} student records!`;
                            if (duplicatesFound > 0) {
                                message += ` ${duplicatesFound} duplicate records were skipped.`;
                            }
                            showToast(message, 'success');
                        } else {
                            let message = 'No new records to import. ';
                            message += duplicatesFound > 0 ? 'All records already exist.' : 'No valid records found.';
                            showToast(message, 'info');
                        }
                    } else {
                        showToast('Invalid data format. Please check the file structure.', 'error');
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    showToast('Error importing data. Please check the file format.', 'error');
                }
            };
            if (file.name.endsWith('.json')) {
                reader.readAsText(file);
            } else if (file.name.endsWith('.csv')) {
                reader.readAsText(file);
            } else if (file.name.endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
            } else {
                showToast('Unsupported file format. Please use JSON, CSV, or Excel.', 'error');
            }
        }
        function renderStudentList() {
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '';
            
            studentDatabase.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                studentItem.dataset.studentId = student.id;
                
                // Determine attendance status for today
                let statusText = "No Record";
                let statusColor = "#ccc";
                
                // Check this student's own attendance data (not the selected student)
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth();
                const day = today.getDate() - 1; // Array is 0-indexed
                
                if (attendanceData[student.id] && 
                    attendanceData[student.id][year] && 
                    attendanceData[student.id][year][month] &&
                    attendanceData[student.id][year][month][day] !== null) {
                    const status = attendanceData[student.id][year][month][day];
                    switch(status) {
                        case 'present':
                            statusText = "Present";
                            statusColor = "#4CAF50";
                            break;
                        case 'absent':
                            statusText = "Absent";
                            statusColor = "#f44336";
                            break;
                        case 'late':
                            statusText = "Late";
                            statusColor = "#FFC107";
                            break;
                    }
                }
                
                studentItem.innerHTML = `
                    <div class="student-name">${student.student.name}</div>
                    <div class="student-grade">${student.student.grade}</div>
                    <div class="attendance-status">
                        <span class="attendance-indicator" style="background-color: ${statusColor};"></span>
                        ${statusText}
                    </div>
                `;
                
                studentItem.addEventListener('click', () => {
                    selectStudentForAttendance(student.id);
                });
                
                studentList.appendChild(studentItem);
            });
            
            updateStudentList(); // Update selection highlighting
        }
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        function selectStudentForAttendance(studentId) {
            const student = studentDatabase.find(s => s.id == studentId);
            if (!student) return;
            
            currentAttendanceView.studentId = studentId;
            showToast(`Selected student: ${student.student.name} (${student.studentId})`, "info");
            document.getElementById('backToMonthlyBtn').style.display = 'inline-flex';
            renderAttendanceCalendar();
            updateStudentList(); // Update student list to show selected student
        }
        function updateStudentList() {
            const studentItems = document.querySelectorAll('.student-item');
            studentItems.forEach(item => {
                const studentId = parseInt(item.dataset.studentId);
                if (studentId === currentAttendanceView.studentId) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }
        function backToMonthlyView() {
            currentAttendanceView.studentId = null;
            document.getElementById('backToMonthlyBtn').style.display = 'none';
            document.getElementById('yearlyAttendanceView').style.display = 'none';
            document.getElementById('attendanceCalendar').style.display = 'block';
            renderAttendanceCalendar();
            updateStudentList(); // Update student list to clear selection
        }
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        function renderAttendanceCalendar() {
            if (!currentAttendanceView.studentId) {
                document.getElementById('attendanceCalendar').innerHTML = '<p style="text-align:center; padding: 20px;">Please select a student first.</p>';
                return;
            }
            
            const student = studentDatabase.find(s => s.id == currentAttendanceView.studentId);
            if (!student) return;
            
            const year = currentAttendanceView.year;
            const month = currentAttendanceView.month;
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysInMonth = getDaysInMonth(year, month);
            
            // Initialize attendance data for this student/month if not exists
            if (!attendanceData[currentAttendanceView.studentId]) attendanceData[currentAttendanceView.studentId] = {};
            if (!attendanceData[currentAttendanceView.studentId][year]) attendanceData[currentAttendanceView.studentId][year] = {};
            if (!attendanceData[currentAttendanceView.studentId][year][month]) {
                attendanceData[currentAttendanceView.studentId][year][month] = Array(daysInMonth).fill(null);
            }
            let studentMonthData = attendanceData[currentAttendanceView.studentId][year][month];
            
            // Apply auto-absent rule for Tuesdays and Wednesdays
            applyAutoAbsentRule(studentMonthData, year, month);
            
            let html = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div>
                            <button class="btn" onclick="changeMonth(-1)"><i class="fas fa-arrow-left"></i> Prev</button>
                        </div>
                        <h3>${firstDay.toLocaleString('default', { month: 'long' })} ${year}</h3>
                        <div>
                            <button class="btn" onclick="changeMonth(1)">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="header">Sun</div>
                        <div class="header">Mon</div>
                        <div class="header">Tue</div>
                        <div class="header">Wed</div>
                        <div class="header">Thu</div>
                        <div class="header">Fri</div>
                        <div class="header">Sat</div>
            `;
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day weekend"></div>';
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayIndex = day - 1;
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6); // Sunday or Saturday
                const isToday = day === today.getDate() && month === currentMonth && year === currentYear;
                const status = studentMonthData[dayIndex];
                
                let dayClass = "calendar-day";
                if (isWeekend) dayClass += " weekend";
                if (isToday) dayClass += " today";
                if (status) dayClass += ` ${status}`;
                
                html += `
                    <div class="${dayClass}" onclick="setAttendance(${dayIndex}, '${student.id}')">
                        ${day}
                        ${status ? `<div class="status-indicator ${status}"></div>` : ''}
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('attendanceCalendar').innerHTML = html;
        }
        function changeMonth(delta) {
            currentAttendanceView.month += delta;
            if (currentAttendanceView.month < 0) {
                currentAttendanceView.month = 11;
                currentAttendanceView.year--;
            } else if (currentAttendanceView.month > 11) {
                currentAttendanceView.month = 0;
                currentAttendanceView.year++;
            }
            renderAttendanceCalendar();
        }
        function setAttendance(dayIndex, studentId) {
            if (!currentAttendanceView.studentId) {
                showToast("Please select a student first.", "warning");
                return;
            }
            
            const student = studentDatabase.find(s => s.id == studentId);
            if (!student) return;
            
            // Get current status
            const year = currentAttendanceView.year;
            const month = currentAttendanceView.month;
            const currentStatus = attendanceData[studentId][year][month][dayIndex];
            
            // Cycle through statuses: null -> present -> absent -> late -> null
            let newStatus = null;
            if (currentStatus === null) {
                newStatus = 'present';
            } else if (currentStatus === 'present') {
                newStatus = 'absent';
            } else if (currentStatus === 'absent') {
                newStatus = 'late';
            }
            
            // Update data
            attendanceData[studentId][year][month][dayIndex] = newStatus;
            
            // Re-render calendar
            renderAttendanceCalendar();
        }
        async function saveAttendanceData() {
            try {
                await saveDataToFiles();
                showToast("Attendance data saved successfully!", "success");
            } catch (error) {
                console.error("Error saving attendance data:", error);
                showToast("Failed to save attendance data. Please try again.", "error");
            }
        }
        function showYearlyAttendance() {
            if (!currentAttendanceView.studentId) {
                showToast("Please select a student first.", "warning");
                return;
            }
            
            const student = studentDatabase.find(s => s.id == currentAttendanceView.studentId);
            if (!student) return;
            
            const yearlyViewDiv = document.getElementById('yearlyAttendanceView');
            const year = currentAttendanceView.year;
            
            let html = `<h3>Yearly Attendance Overview for ${student.student.name} (${year})</h3>`;
            html += `<div class="months-grid">`;
            
            for (let month = 0; month < 12; month++) {
                const monthName = new Date(year, month, 1).toLocaleString('default', { month: 'short' });
                
                // Calculate attendance stats for this month
                let present = 0, absent = 0, late = 0;
                if (attendanceData[student.id] && attendanceData[student.id][year] && attendanceData[student.id][year][month]) {
                    attendanceData[student.id][year][month].forEach(status => {
                        if (status === 'present') present++;
                        else if (status === 'absent') absent++;
                        else if (status === 'late') late++;
                    });
                }
                
                const total = present + absent + late;
                const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                
                html += `
                    <div class="month-card">
                        <h4>${monthName}</h4>
                        <div class="month-stats">
                            <div>Present: ${present}</div>
                            <div>Absent: ${absent}</div>
                            <div>Late: ${late}</div>
                            <div><strong>${percentage}%</strong></div>
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            yearlyViewDiv.innerHTML = html;
            
            // Show yearly view and hide monthly
            document.getElementById('attendanceCalendar').style.display = 'none';
            yearlyViewDiv.style.display = 'block';
        }
        // Teacher Functions
        function populateYearSelect() {
            const yearSelect = document.getElementById('yearSelect');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            
            yearSelect.innerHTML = '';
            for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }
        function populateTeacherYearSelect() {
            const yearSelect = document.getElementById('teacherYearSelect');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            
            yearSelect.innerHTML = '';
            for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }
        function populateTeacherAttendanceSelect() {
            const select = document.getElementById('teacherAttendanceSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Teacher</option>';
            
            teacherDatabase.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = `${teacher.name} (${teacher.subject})`;
                select.appendChild(option);
            });
        }
        async function addTeacher() {
            // Validate teacher form
            let isValid = true;
            isValid = validateInput('teacherName', 'teacherNameError', validateName, 'Please enter a valid name (letters, spaces, hyphens, apostrophes only).') && isValid;
            isValid = validateInput('teacherSubject', 'teacherSubjectError', validateRequired, 'Please enter a valid subject/department.') && isValid;
            isValid = validateInput('teacherPhone', 'teacherPhoneError', validatePhone, 'Please enter a valid phone number (digits, spaces, hyphens, plus, parentheses only).') && isValid;
            isValid = validateInput('teacherEmail', 'teacherEmailError', validateEmail, 'Please enter a valid email address.') && isValid;
            isValid = validateInput('teacherHasWwcc', 'teacherWwccError', validateRequired, 'Please select an option for WWCC.') && isValid;
            // Additional validation if WWCC is yes
            const hasWwcc = document.getElementById('teacherHasWwcc').value;
            if (hasWwcc === 'yes') {
                if (!document.getElementById('wwccCardNumber').value) {
                    showToast('Please enter WWCC card number', 'error');
                    isValid = false;
                }
                if (!document.getElementById('wwccExpiryDate').value) {
                    showToast('Please enter WWCC expiry date', 'error');
                    isValid = false;
                }
            }
            if (!isValid) {
                showToast('Please fix the errors in the form before saving.', 'error');
                return;
            }
            // Collect data
            const teacherData = {
                id: nextTeacherId++,
                name: document.getElementById('teacherName').value,
                subject: document.getElementById('teacherSubject').value,
                phone: document.getElementById('teacherPhone').value,
                email: document.getElementById('teacherEmail').value,
                hasWwcc: document.getElementById('teacherHasWwcc').value
            };
            // Add WWCC data if applicable
            if (hasWwcc === 'yes') {
                teacherData.wwcc = {
                    fullName: document.getElementById('wwccFullName').value,
                    otherNames: document.getElementById('wwccOtherNames').value,
                    position: document.getElementById('wwccPosition').value,
                    campus: document.getElementById('wwccCampus').value,
                    cardNumber: document.getElementById('wwccCardNumber').value,
                    expiryDate: document.getElementById('wwccExpiryDate').value,
                    vitNumber: document.getElementById('wwccVitNumber').value,
                    vitExpiry: document.getElementById('wwccVitExpiry').value
                };
            }
            // Add to database
            teacherDatabase.push(teacherData);
            // Initialize attendance data
            if (!teacherAttendanceData[teacherData.id]) {
                teacherAttendanceData[teacherData.id] = {};
                const currentYear = new Date().getFullYear();
                for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                    teacherAttendanceData[teacherData.id][y] = {};
                    for (let m = 0; m < 12; m++) {
                        teacherAttendanceData[teacherData.id][y][m] = Array(getDaysInMonth(y, m)).fill(null);
                    }
                }
            }
            // Save and update UI
            await saveDataToFiles();
            updateTeacherView();
            populateTeacherAttendanceSelect();
            updateReports();
            // Reset form
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherPhone').value = '';
            document.getElementById('teacherEmail').value = '';
            document.getElementById('teacherHasWwcc').value = '';
            document.getElementById('wwccForm').style.display = 'none';
            document.getElementById('wwccFullName').value = '';
            document.getElementById('wwccOtherNames').value = '';
            document.getElementById('wwccPosition').value = '';
            document.getElementById('wwccCardNumber').value = '';
            document.getElementById('wwccExpiryDate').value = '';
            document.getElementById('wwccVitNumber').value = '';
            document.getElementById('wwccVitExpiry').value = '';
            showToast('Teacher added successfully!', 'success');
        }
        function updateTeacherView() {
            const tbody = document.getElementById('teacherTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            teacherDatabase.forEach(teacher => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>TEA-${String(teacher.id).padStart(4, '0')}</td>
                    <td>${teacher.name}</td>
                    <td>${teacher.subject}</td>
                    <td>${teacher.phone}</td>
                    <td>${teacher.email}</td>
                    <td>${teacher.hasWwcc === 'yes' ? 'Valid' : 'No WWCC'}</td>
                    <td>
                        <button class="btn" onclick='viewTeacherDetails(${teacher.id})'><i class="fas fa-eye"></i> View</button>
                        <button class="btn btn-danger" onclick='deleteTeacher(${teacher.id})'><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function filterTeachers() {
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#teacherTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        function viewTeacherDetails(teacherId) {
            const teacher = teacherDatabase.find(t => t.id == teacherId);
            if (!teacher) return;
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(teacher.name)}&size=100&background=4361ee&color=fff" alt="Teacher Avatar" style="border-radius: 50%; margin-bottom: 15px;">
                    <h3>${teacher.name}</h3>
                    <p>Teacher ID: TEA-${String(teacher.id).padStart(4, '0')}</p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Contact Information</h4>
                        <p><strong>Subject/Department:</strong> ${teacher.subject}</p>
                        <p><strong>Phone:</strong> ${teacher.phone}</p>
                        <p><strong>Email:</strong> ${teacher.email}</p>
                        <p><strong>WWCC Status:</strong> ${teacher.hasWwcc === 'yes' ? 'Valid' : 'No WWCC - Please contact management'}</p>
                    </div>
                    <div>
                        <h4>Attendance Summary</h4>
                        <p>Total Present: ${calculateTeacherAttendance(teacher.id, 'present')}</p>
                        <p>Total Absent: ${calculateTeacherAttendance(teacher.id, 'absent')}</p>
                        <p>Total Late: ${calculateTeacherAttendance(teacher.id, 'late')}</p>
                    </div>
                </div>
            `;
            // Add WWCC details if available
            if (teacher.hasWwcc === 'yes' && teacher.wwcc) {
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>WWCC Details</h4>
                        <p><strong>Full Name:</strong> ${teacher.wwcc.fullName || 'Not provided'}</p>
                        <p><strong>Other Names:</strong> ${teacher.wwcc.otherNames || 'Not provided'}</p>
                        <p><strong>Position:</strong> ${teacher.wwcc.position || 'Not provided'}</p>
                        <p><strong>Campus:</strong> ${teacher.wwcc.campus || 'Not provided'}</p>
                        <p><strong>WWCC Card Number:</strong> ${teacher.wwcc.cardNumber || 'Not provided'}</p>
                        <p><strong>WWCC Expiry Date:</strong> ${teacher.wwcc.expiryDate || 'Not provided'}</p>
                        ${teacher.wwcc.vitNumber ? `<p><strong>VIT Registration Number:</strong> ${teacher.wwcc.vitNumber}</p>` : ''}
                        ${teacher.wwcc.vitExpiry ? `<p><strong>VIT Expiry Date:</strong> ${teacher.wwcc.vitExpiry}</p>` : ''}
                    </div>
                `;
            }
            document.getElementById('teacherDetailsContent').innerHTML = html;
            document.getElementById('teacherDetailsModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }
        function calculateTeacherAttendance(teacherId, status) {
            let count = 0;
            
            if (teacherAttendanceData[teacherId]) {
                Object.values(teacherAttendanceData[teacherId]).forEach(yearData => {
                    Object.values(yearData).forEach(monthData => {
                        monthData.forEach(dayStatus => {
                            if (dayStatus === status) {
                                count++;
                            }
                        });
                    });
                });
            }
            
            return count;
        }
        async function deleteTeacher(teacherId) {
            if (confirm('Are you sure you want to delete this teacher record?')) {
                teacherDatabase = teacherDatabase.filter(t => t.id != teacherId);
                delete teacherAttendanceData[teacherId]; // Remove attendance data
                
                updateTeacherView();
                populateTeacherAttendanceSelect();
                updateReports();
                await saveDataToFiles();
                
                showToast('Teacher record deleted successfully!', 'success');
            }
        }
        function selectTeacherForAttendance() {
            const select = document.getElementById('teacherAttendanceSelect');
            if (!select) return;
            
            const teacherId = parseInt(select.value);
            
            if (!teacherId) {
                currentTeacherAttendanceView.teacherId = null;
                document.getElementById('teacherAttendanceCalendar').innerHTML = '<p style="text-align:center; padding: 20px;">Please select a teacher first.</p>';
                return;
            }
            
            const teacher = teacherDatabase.find(t => t.id == teacherId);
            if (!teacher) return;
            
            currentTeacherAttendanceView.teacherId = teacherId;
            showToast(`Selected teacher: ${teacher.name}`, "info");
            renderTeacherAttendanceCalendar();
        }
        function renderTeacherAttendanceCalendar() {
            if (!currentTeacherAttendanceView.teacherId) {
                document.getElementById('teacherAttendanceCalendar').innerHTML = '<p style="text-align:center; padding: 20px;">Please select a teacher first.</p>';
                return;
            }
            
            const teacher = teacherDatabase.find(t => t.id == currentTeacherAttendanceView.teacherId);
            if (!teacher) return;
            
            const year = currentTeacherAttendanceView.year;
            const month = currentTeacherAttendanceView.month;
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysInMonth = getDaysInMonth(year, month);
            
            // Initialize attendance data for this teacher/month if not exists
            if (!teacherAttendanceData[currentTeacherAttendanceView.teacherId]) 
                teacherAttendanceData[currentTeacherAttendanceView.teacherId] = {};
            if (!teacherAttendanceData[currentTeacherAttendanceView.teacherId][year]) 
                teacherAttendanceData[currentTeacherAttendanceView.teacherId][year] = {};
            if (!teacherAttendanceData[currentTeacherAttendanceView.teacherId][year][month]) {
                teacherAttendanceData[currentTeacherAttendanceView.teacherId][year][month] = Array(daysInMonth).fill(null);
            }
            
            let teacherMonthData = teacherAttendanceData[currentTeacherAttendanceView.teacherId][year][month];
            
            let html = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div>
                            <button class="btn" onclick="changeTeacherMonth(-1)"><i class="fas fa-arrow-left"></i> Prev</button>
                        </div>
                        <h3>${firstDay.toLocaleString('default', { month: 'long' })} ${year}</h3>
                        <div>
                            <button class="btn" onclick="changeTeacherMonth(1)">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="header">Sun</div>
                        <div class="header">Mon</div>
                        <div class="header">Tue</div>
                        <div class="header">Wed</div>
                        <div class="header">Thu</div>
                        <div class="header">Fri</div>
                        <div class="header">Sat</div>
            `;
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day weekend"></div>';
            }
            
            // Add cells for each day of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayIndex = day - 1;
                const isWeekend = (startDay + dayIndex) % 7 === 0 || (startDay + dayIndex) % 7 === 6;
                const isToday = day === today.getDate() && month === currentMonth && year === currentYear;
                const status = teacherMonthData[dayIndex];
                
                let dayClass = "calendar-day";
                if (isWeekend) dayClass += " weekend";
                if (isToday) dayClass += " today";
                if (status) dayClass += ` ${status}`;
                
                html += `
                    <div class="${dayClass}" onclick="setTeacherAttendance(${dayIndex})">
                        ${day}
                        ${status ? `<div class="status-indicator ${status}"></div>` : ''}
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('teacherAttendanceCalendar').innerHTML = html;
        }
        function changeTeacherMonth(delta) {
            currentTeacherAttendanceView.month += delta;
            if (currentTeacherAttendanceView.month < 0) {
                currentTeacherAttendanceView.month = 11;
                currentTeacherAttendanceView.year--;
            } else if (currentTeacherAttendanceView.month > 11) {
                currentTeacherAttendanceView.month = 0;
                currentTeacherAttendanceView.year++;
            }
            renderTeacherAttendanceCalendar();
        }
        function setTeacherAttendance(dayIndex) {
            if (!currentTeacherAttendanceView.teacherId) {
                showToast("Please select a teacher first.", "warning");
                return;
            }
            
            // Get current status
            const year = currentTeacherAttendanceView.year;
            const month = currentTeacherAttendanceView.month;
            const currentStatus = teacherAttendanceData[currentTeacherAttendanceView.teacherId][year][month][dayIndex];
            
            // Cycle through statuses: null -> present -> absent -> late -> null
            let newStatus = null;
            if (currentStatus === null) {
                newStatus = 'present';
            } else if (currentStatus === 'present') {
                newStatus = 'absent';
            } else if (currentStatus === 'absent') {
                newStatus = 'late';
            }
            
            // Update data
            teacherAttendanceData[currentTeacherAttendanceView.teacherId][year][month][dayIndex] = newStatus;
            
            // Re-render calendar
            renderTeacherAttendanceCalendar();
        }
        async function saveTeacherAttendanceData() {
            try {
                await saveDataToFiles();
                showToast("Teacher attendance data saved successfully!", "success");
            } catch (error) {
                console.error("Error saving teacher attendance data:", error);
                showToast("Failed to save teacher attendance data. Please try again.", "error");
            }
        }
        // WWCC Form Functions
        function toggleWwccForm() {
            const hasWwcc = document.getElementById('teacherHasWwcc').value;
            const wwccForm = document.getElementById('wwccForm');
            
            if (hasWwcc === 'yes') {
                wwccForm.style.display = 'block';
            } else {
                wwccForm.style.display = 'none';
            }
        }
        function validateWwccForm() {
            let isValid = true;
            
            if (document.getElementById('teacherHasWwcc').value === 'yes') {
                const cardNumber = document.getElementById('wwccCardNumber');
                const expiryDate = document.getElementById('wwccExpiryDate');
                
                if (!cardNumber.value.trim()) {
                    cardNumber.classList.add('error');
                    isValid = false;
                } else {
                    cardNumber.classList.remove('error');
                }
                
                if (!expiryDate.value) {
                    expiryDate.classList.add('error');
                    isValid = false;
                } else {
                    expiryDate.classList.remove('error');
                }
            }
            
            return isValid;
        }
        // CLV Tab Navigation
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize CLV tabs if they exist
            const clvTabs = document.querySelectorAll('.clv-tab');
            if (clvTabs.length > 0) {
                const clvTabContents = document.querySelectorAll('.clv-tab-content');
                
                clvTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTabId = tab.getAttribute('data-clv-tab');
                        
                        // Update active tab
                        clvTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Show target content
                        clvTabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === targetTabId) {
                                content.classList.add('active');
                            }
                        });
                    });
                });
                
                // Image upload preview
                const imageUpload = document.getElementById('clvImageUpload');
                if (imageUpload) {
                    const imagePreview = document.getElementById('imagePreview');
                    
                    imageUpload.addEventListener('change', function() {
                        const file = this.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                            }
                            reader.readAsDataURL(file);
                        }
                    });
                }
                
                // Set default values
                document.getElementById('clvDate').valueAsDate = new Date();
                
                // Load students for dropdown
                loadStudentsForCLV();
                
                // Load CLV records
                loadCLVRecords();
            }
        });
        
        // Load students for CLV form dropdown
        function loadStudentsForCLV() {
            const studentSelect = document.getElementById('clvStudent');
            if (!studentSelect) return;
            
            // Clear existing options except the first one
            while (studentSelect.options.length > 1) {
                studentSelect.remove(1);
            }
            
            // Add students from your database
            if (studentDatabase && studentDatabase.length > 0) {
                studentDatabase.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id; // Store the student ID as value
                    option.textContent = `${student.student.name} - ${student.student.grade}`;
                    option.setAttribute('data-student-id', student.studentId);
                    option.setAttribute('data-student-grade', student.student.grade);
                    option.setAttribute('data-student-school', student.student.currentSchool);
                    option.setAttribute('data-parent-name', student.parent.name);
                    studentSelect.appendChild(option);
                });
            } else {
                // Fallback to sample data if database is empty
                const sampleStudents = [
                    {id: 1, studentId: 'TAS-00001', name: 'Ali Ahmed', grade: 'Grade 3', school: 'Dandenong Primary', parent: 'Ahmed Khan'},
                    {id: 2, studentId: 'TAS-00002', name: 'Sarah Mohammed', grade: 'Grade 5', school: 'Noble Park Secondary', parent: 'Fatima Mohammed'},
                    {id: 3, studentId: 'TAS-00003', name: 'Omar Khan', grade: 'Grade 2', school: 'Springvale Elementary', parent: 'Hassan Khan'}
                ];
                
                sampleStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} - ${student.grade}`;
                    option.setAttribute('data-student-id', student.studentId);
                    option.setAttribute('data-student-grade', student.grade);
                    option.setAttribute('data-student-school', student.school);
                    option.setAttribute('data-parent-name', student.parent);
                    studentSelect.appendChild(option);
                });
            }
            
            // Set current teacher (you would get this from your logged-in user)
            const clvTeacher = document.getElementById('clvTeacher');
            if (clvTeacher) {
                clvTeacher.value = "Mojahid Agha";
            }
            
            // Add event listener to show student details when selected
            studentSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const studentInfoDiv = document.getElementById('selectedStudentInfo');
                
                if (this.value) {
                    document.getElementById('studentIdDisplay').textContent = selectedOption.getAttribute('data-student-id');
                    document.getElementById('studentGradeDisplay').textContent = selectedOption.getAttribute('data-student-grade');
                    document.getElementById('studentSchoolDisplay').textContent = selectedOption.getAttribute('data-student-school');
                    document.getElementById('studentParentDisplay').textContent = selectedOption.getAttribute('data-parent-name');
                    studentInfoDiv.style.display = 'block';
                } else {
                    studentInfoDiv.style.display = 'none';
                }
            });
        }
        // CLV Form Functions
        function saveCLVForm() {
            // Validate form
            const student = document.getElementById('clvStudent').value;
            const date = document.getElementById('clvDate').value;
            const subject = document.getElementById('clvSubject').value;
            const topic = document.getElementById('clvTopic').value;
            const level = document.getElementById('clvLevel').value;
            
            if (!student || !date || !subject || !topic || !level) {
                alert('Please fill in all required fields');
                return;
            }
            
            // In a real application, this would save to your SQLite database
            // For now, we'll just show a success message
            alert('CLV form saved successfully as draft!');
        }
        function resetCLVForm() {
            if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
                const clvFormData = document.getElementById('clvFormData');
                if (clvFormData) {
                    clvFormData.reset();
                    const clvDate = document.getElementById('clvDate');
                    if (clvDate) {
                        clvDate.valueAsDate = new Date();
                    }
                    const imagePreview = document.getElementById('imagePreview');
                    if (imagePreview) {
                        imagePreview.innerHTML = '<i class="fas fa-image" style="font-size: 48px; color: #ccc;"></i>';
                    }
                }
            }
        }
        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const clvFormData = document.getElementById('clvFormData');
            if (clvFormData) {
                clvFormData.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Validate form
                    const student = document.getElementById('clvStudent').value;
                    const date = document.getElementById('clvDate').value;
                    const subject = document.getElementById('clvSubject').value;
                    const topic = document.getElementById('clvTopic').value;
                    const level = document.getElementById('clvLevel').value;
                    
                    if (!student || !date || !subject || !topic || !level) {
                        alert('Please fill in all required fields');
                        return;
                    }
                    
                    // Get the selected student option
                    const studentSelect = document.getElementById('clvStudent');
                    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
                    
                    // Collect form data
                    const formData = {
                        id: this.dataset.editingId || Date.now(), // Use existing ID if editing, otherwise generate new
                        student_id: selectedOption.getAttribute('data-student-id'),
                        student_db_id: student,
                        student_name: selectedOption.textContent.split(' - ')[0],
                        assessment_date: date,
                        teacher: document.getElementById('clvTeacher').value,
                        term: document.getElementById('clvTerm').value,
                        subject: subject,
                        topic: topic,
                        achievement_level: level,
                        score: document.getElementById('clvScore').value,
                        comments: document.getElementById('clvComments').value,
                        understanding: document.getElementById('clvUnderstanding').value,
                        application: document.getElementById('clvApplication').value,
                        participation: document.getElementById('clvParticipation').value,
                        behavior: document.getElementById('clvBehavior').value,
                        evidence_desc: document.getElementById('clvEvidenceDesc').value,
                        goals: document.getElementById('clvGoals').value,
                        support_strategies: document.getElementById('clvSupport').value,
                        parent_communication: document.getElementById('clvParentComm').value,
                        status: 'completed'
                    };
                    
                    // Check if we're editing an existing record or creating a new one
                    if (this.dataset.editingId) {
                        // Update existing record
                        const index = clvRecords.findIndex(r => r.id == this.dataset.editingId);
                        if (index !== -1) {
                            clvRecords[index] = formData;
                        }
                        delete this.dataset.editingId; // Clear editing flag
                    } else {
                        // Add new record
                        clvRecords.push(formData);
                    }
                    
                    // Save to localStorage
                    localStorage.setItem(CLV_RECORDS_FILE, JSON.stringify(clvRecords));
                    
                    // Show success message
                    alert(`CLV form submitted successfully for ${formData.student_name}!`);
                    
                    // Reset form after submission
                    this.reset();
                    const clvDate = document.getElementById('clvDate');
                    if (clvDate) {
                        clvDate.valueAsDate = new Date();
                    }
                    const imagePreview = document.getElementById('imagePreview');
                    if (imagePreview) {
                        imagePreview.innerHTML = '<i class="fas fa-image" style="font-size: 48px; color: #ccc;"></i>';
                    }
                    const selectedStudentInfo = document.getElementById('selectedStudentInfo');
                    if (selectedStudentInfo) {
                        selectedStudentInfo.style.display = 'none';
                    }
                    
                    // Reload CLV records
                    loadCLVRecords();
                    
                    // Switch to records tab
                    const clvRecordsTab = document.querySelector('[data-clv-tab="clvRecords"]');
                    if (clvRecordsTab) {
                        clvRecordsTab.click();
                    }
                });
            }
        });
        // Load CLV records from database
        function loadCLVRecords() {
            const tbody = document.getElementById('clvTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (clvRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No CLV records found</td></tr>';
                return;
            }
            
            clvRecords.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.student_name} (${record.student_id})</td>
                    <td>${record.subject}</td>
                    <td>${record.assessment_date}</td>
                    <td>${record.topic}</td>
                    <td>${record.achievement_level}</td>
                    <td><span class="clv-status status-${record.status}">${formatStatus(record.status)}</span></td>
                    <td>
                        <button class="btn" onclick="viewCLVDetails(${record.id})"><i class="fas fa-eye"></i> View</button>
                        <button class="btn btn-warning" onclick="editCLVRecord(${record.id})"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger" onclick="deleteCLVRecord(${record.id})"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        function deleteCLVRecord(recordId) {
            if (confirm('Are you sure you want to delete this CLV record?')) {
                // Remove the record from the CLV database
                clvRecords = clvRecords.filter(record => record.id != recordId);
                
                // Save the updated database
                localStorage.setItem(CLV_RECORDS_FILE, JSON.stringify(clvRecords));
                
                // Show success message
                showToast('CLV record deleted successfully', 'success');
                
                // Reload the CLV records to reflect changes
                loadCLVRecords();
            }
        }
        // CLV Records Functions
        function filterCLVRecords() {
            const searchTerm = document.getElementById('clvSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('clvFilterStatus')?.value || '';
            const subjectFilter = document.getElementById('clvFilterSubject')?.value || '';
            
            const rows = document.querySelectorAll('#clvTableBody tr');
            rows.forEach(row => {
                const student = row.cells[0].textContent.toLowerCase();
                const subject = row.cells[1].textContent.toLowerCase();
                const statusClass = row.cells[5].querySelector('.clv-status').classList;
                
                let statusMatch = true;
                if (statusFilter) {
                    statusMatch = statusClass.contains(`status-${statusFilter}`);
                }
                
                let subjectMatch = true;
                if (subjectFilter) {
                    subjectMatch = row.cells[1].textContent === subjectFilter;
                }
                
                const matchesSearch = student.includes(searchTerm) || subject.includes(searchTerm);
                
                if (matchesSearch && statusMatch && subjectMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        function viewCLVDetails(id) {
            // Find the CLV record in the database
            const clvRecord = clvRecords.find(r => r.id == id);
            if (!clvRecord) {
                showToast('CLV record not found', 'error');
                return;
            }
            
            // Find the student in the database
            const student = studentDatabase.find(s => s.id == clvRecord.student_db_id);
            if (!student) {
                showToast('Associated student not found', 'error');
                return;
            }
            
            // Create a modal with CLV record details
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '1001';
            
            // Format skills ratings
            const formatRating = (rating) => {
                const ratings = ['', '1 - Needs Improvement', '2 - Developing', '3 - Satisfactory', '4 - Good', '5 - Excellent'];
                return ratings[rating] || 'Not Rated';
            };
            
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>CLV Record Details</h3>
                    <button class="btn" onclick="this.closest('.modal').remove(); document.getElementById('modalOverlay').style.display='none';">×</button>
                </div>
                <div style="padding: 20px;">
                    <h4>Student Information</h4>
                    <p><strong>Student ID:</strong> ${clvRecord.student_id}</p>
                    <p><strong>Name:</strong> ${clvRecord.student_name}</p>
                    <p><strong>Grade:</strong> ${student.student.grade}</p>
                    <p><strong>Current School:</strong> ${student.student.currentSchool}</p>
                    
                    <h4 style="margin-top: 20px;">Assessment Information</h4>
                    <p><strong>Assessment Date:</strong> ${clvRecord.assessment_date}</p>
                    <p><strong>Teacher:</strong> ${clvRecord.teacher}</p>
                    <p><strong>Term:</strong> ${clvRecord.term}</p>
                    <p><strong>Subject:</strong> ${clvRecord.subject}</p>
                    <p><strong>Topic/Unit:</strong> ${clvRecord.topic}</p>
                    <p><strong>Achievement Level:</strong> ${clvRecord.achievement_level}</p>
                    <p><strong>Assessment Score:</strong> ${clvRecord.score || 'Not scored'}</p>
                    
                    <h4 style="margin-top: 20px;">Teacher Comments</h4>
                    <p>${clvRecord.comments || 'No comments provided'}</p>
                    
                    <h4 style="margin-top: 20px;">Skills Evaluation</h4>
                    <p><strong>Understanding of Concepts:</strong> ${formatRating(clvRecord.understanding)}</p>
                    <p><strong>Application of Knowledge:</strong> ${formatRating(clvRecord.application)}</p>
                    <p><strong>Class Participation:</strong> ${formatRating(clvRecord.participation)}</p>
                    <p><strong>Classroom Behavior:</strong> ${formatRating(clvRecord.behavior)}</p>
                    
                    <h4 style="margin-top: 20px;">Learning Evidence</h4>
                    <p>${clvRecord.evidence_desc || 'No evidence description provided'}</p>
                    
                    <h4 style="margin-top: 20px;">Next Steps & Recommendations</h4>
                    <p><strong>Learning Goals:</strong> ${clvRecord.goals || 'No goals specified'}</p>
                    <p><strong>Support Strategies:</strong> ${clvRecord.support_strategies || 'No strategies specified'}</p>
                    <p><strong>Parent Communication:</strong> ${clvRecord.parent_communication || 'No communication notes'}</p>
                    
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-info" onclick="showPrintPreview('clvDetails', ${id})"><i class="fas fa-print"></i> Print</button>
                        <button class="btn" onclick="this.closest('.modal').remove(); document.getElementById('modalOverlay').style.display='none';">Close</button>
                    </div>
                </div>
            `;
            
            // Add modal to the page
            document.body.appendChild(modal);
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'block';
            }
        }
        function editCLVRecord(id) {
            // Find the CLV record in the database
            const clvRecord = clvRecords.find(r => r.id == id);
            if (!clvRecord) {
                showToast('CLV record not found', 'error');
                return;
            }
            
            // Switch to the CLV Form tab
            const clvFormTab = document.querySelector('[data-clv-tab="clvForm"]');
            if (clvFormTab) {
                clvFormTab.click();
            }
            
            // Pre-fill the form with CLV record data
            const studentSelect = document.getElementById('clvStudent');
            if (studentSelect) {
                studentSelect.value = clvRecord.student_db_id;
                
                // Trigger the change event to show student details
                studentSelect.dispatchEvent(new Event('change'));
            }
            
            // Fill in the rest of the form
            const clvDate = document.getElementById('clvDate');
            if (clvDate) {
                clvDate.value = clvRecord.assessment_date;
            }
            const clvTeacher = document.getElementById('clvTeacher');
            if (clvTeacher) {
                clvTeacher.value = clvRecord.teacher;
            }
            const clvTerm = document.getElementById('clvTerm');
            if (clvTerm) {
                clvTerm.value = clvRecord.term;
            }
            const clvSubject = document.getElementById('clvSubject');
            if (clvSubject) {
                clvSubject.value = clvRecord.subject;
            }
            const clvTopic = document.getElementById('clvTopic');
            if (clvTopic) {
                clvTopic.value = clvRecord.topic;
            }
            const clvLevel = document.getElementById('clvLevel');
            if (clvLevel) {
                clvLevel.value = clvRecord.achievement_level;
            }
            const clvScore = document.getElementById('clvScore');
            if (clvScore) {
                clvScore.value = clvRecord.score || '';
            }
            const clvComments = document.getElementById('clvComments');
            if (clvComments) {
                clvComments.value = clvRecord.comments || '';
            }
            const clvUnderstanding = document.getElementById('clvUnderstanding');
            if (clvUnderstanding) {
                clvUnderstanding.value = clvRecord.understanding || '';
            }
            const clvApplication = document.getElementById('clvApplication');
            if (clvApplication) {
                clvApplication.value = clvRecord.application || '';
            }
            const clvParticipation = document.getElementById('clvParticipation');
            if (clvParticipation) {
                clvParticipation.value = clvRecord.participation || '';
            }
            const clvBehavior = document.getElementById('clvBehavior');
            if (clvBehavior) {
                clvBehavior.value = clvRecord.behavior || '';
            }
            const clvEvidenceDesc = document.getElementById('clvEvidenceDesc');
            if (clvEvidenceDesc) {
                clvEvidenceDesc.value = clvRecord.evidence_desc || '';
            }
            const clvGoals = document.getElementById('clvGoals');
            if (clvGoals) {
                clvGoals.value = clvRecord.goals || '';
            }
            const clvSupport = document.getElementById('clvSupport');
            if (clvSupport) {
                clvSupport.value = clvRecord.support_strategies || '';
            }
            const clvParentComm = document.getElementById('clvParentComm');
            if (clvParentComm) {
                clvParentComm.value = clvRecord.parent_communication || '';
            }
            
            // Show a notification
            showToast(`Editing CLV record for ${clvRecord.student_name}`, 'info');
            
            // Store the ID of the record being edited
            const clvFormData = document.getElementById('clvFormData');
            if (clvFormData) {
                clvFormData.dataset.editingId = id;
            }
        }
        function generateFeeReport() {
            let html = `
                <div style="text-align:center; margin-bottom: 20px;">
                    <img src="${schoolLogo}" alt="School Logo" style="max-width:100px;">
                    <h1>${schoolName}</h1>
                    <p>${schoolAddress}</p>
                    <p>${schoolABN}</p>
                    <h2>All Fees Report</h2>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
                
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Parent Name</th>
                            <th>Grade</th>
                            <th>Total Paid ($)</th>
                            <th>Balance ($)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let overallTotalPaid = 0;
            let overallTotalPending = 0;
            const feePerChild = 30; // $30 per child as pending amount
            
            studentDatabase.forEach(student => {
                let totalPaid = 0;
                if (feeRecords[student.id]) {
                    feeRecords[student.id].forEach(fee => {
                        totalPaid += fee.amount;
                    });
                }
                
                // Calculate balance (pending amount)
                const balance = totalPaid >= feePerChild ? 0 : feePerChild - totalPaid;
                const balanceColor = balance === 0 ? '#4CAF50' : '#03A9F4'; // Green if paid, Sky blue if pending
                
                overallTotalPaid += totalPaid;
                overallTotalPending += balance;
                
                html += `
                    <tr>
                        <td>${student.studentId}</td>
                        <td>${student.student.name}</td>
                        <td>${student.parent.name}</td>
                        <td>${student.student.grade}</td>
                        <td>${totalPaid.toFixed(2)}</td>
                        <td style="color: ${balanceColor}; font-weight: bold;">
                            ${balance === 0 ? '0.00' : balance.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4">Overall Totals</th>
                            <th>$${overallTotalPaid.toFixed(2)}</th>
                            <th style="color: #03A9F4; font-weight: bold;">$${overallTotalPending.toFixed(2)}</th>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            const feeReportContent = document.getElementById('feeReportContent');
            if (feeReportContent) {
                feeReportContent.innerHTML = html;
            }
            const feeReportSection = document.getElementById('feeReportSection');
            if (feeReportSection) {
                feeReportSection.style.display = 'block';
            }
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'block';
            }
        }
        function generateMonthlyFeeReport() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const monthName = new Date(currentYear, currentMonth, 1).toLocaleString('default', { month: 'long' });
            
            let html = `
                <div style="text-align:center; margin-bottom: 20px;">
                    <img src="${schoolLogo}" alt="School Logo" style="max-width:100px;">
                    <h1>${schoolName}</h1>
                    <p>${schoolAddress}</p>
                    <p>${schoolABN}</p>
                    <h2>Monthly Fees Report - ${monthName} ${currentYear}</h2>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
                
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Parent Name</th>
                            <th>Grade</th>
                            <th>Amount Paid ($)</th>
                            <th>Date</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let monthlyTotal = 0;
            
            studentDatabase.forEach(student => {
                if (feeRecords[student.id]) {
                    feeRecords[student.id].forEach(fee => {
                        const feeDate = new Date(fee.date);
                        if (feeDate.getFullYear() === currentYear && feeDate.getMonth() === currentMonth) {
                            monthlyTotal += fee.amount;
                            
                            html += `
                                <tr>
                                    <td>${student.studentId}</td>
                                    <td>${student.student.name}</td>
                                    <td>${student.parent.name}</td>
                                    <td>${student.student.grade}</td>
                                    <td>${fee.amount.toFixed(2)}</td>
                                    <td>${fee.date}</td>
                                    <td>${fee.description}</td>
                                </tr>
                            `;
                        }
                    });
                }
            });
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4">Monthly Total</th>
                            <th>$${monthlyTotal.toFixed(2)}</th>
                            <th colspan="2"></th>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            const monthlyFeeReportContent = document.getElementById('monthlyFeeReportContent');
            if (monthlyFeeReportContent) {
                monthlyFeeReportContent.innerHTML = html;
            }
            const monthlyFeeReportModal = document.getElementById('monthlyFeeReportModal');
            if (monthlyFeeReportModal) {
                monthlyFeeReportModal.style.display = 'block';
            }
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'block';
            }
        }
        function viewIndividualFeeReport(studentId) {
            const student = studentDatabase.find(s => s.id == studentId);
            if (!student) return;
            
            const records = feeRecords[studentId] || [];
            
            let html = `
                <div style="text-align:center; margin-bottom: 20px;">
                    <img src="${schoolLogo}" alt="School Logo" style="max-width:100px;">
                    <h1>${schoolName}</h1>
                    <p>${schoolAddress}</p>
                    <p>${schoolABN}</p>
                    <h2>Fee Payment Report</h2>
                    <p>Student: ${student.student.name} (${student.studentId})<br>
                    Parent: ${student.parent.name}<br>
                    Grade: ${student.student.grade}</p>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                </div>
                
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount ($)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let totalPaid = 0;
            records.forEach(record => {
                html += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.description}</td>
                        <td>${record.amount.toFixed(2)}</td>
                    </tr>
                `;
                totalPaid += record.amount;
            });
            
            // REMOVED THE TOTAL FEES AND BALANCE CALCULATION SINCE WE'RE ONLY TRACKING PAYMENTS
            // OR IF YOU WANT TO KEEP IT, MAKE IT POSITIVE:
            const totalFees = totalPaid; // Now showing total paid as total fees
            const balance = 0; // Since we're not tracking outstanding fees
            
            html += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="2">Total Paid</th>
                            <th>$${totalPaid.toFixed(2)}</th>
                        </tr>
                        <tr>
                            <th colspan="2">Total Fees</th>
                            <th>$${totalFees.toFixed(2)}</th>
                        </tr>
                        <tr>
                            <th colspan="2">Balance</th>
                            <th>$${balance.toFixed(2)}</th>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            const individualFeeReportContent = document.getElementById('individualFeeReportContent');
            if (individualFeeReportContent) {
                individualFeeReportContent.innerHTML = html;
            }
            const individualFeeReportModal = document.getElementById('individualFeeReportModal');
            if (individualFeeReportModal) {
                individualFeeReportModal.style.display = 'block';
            }
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'block';
            }
        }
        function editFeeRecords(studentId) {
            const student = studentDatabase.find(s => s.id == studentId);
            if (!student) return;
            const feeEntriesContainer = document.getElementById('feeEntriesContainer');
            if (feeEntriesContainer) {
                feeEntriesContainer.innerHTML = '<h3>Editing Fees for: ' + student.student.name + '</h3>';
            }
            
            if (feeRecords[studentId]) {
                feeRecords[studentId].forEach((fee, index) => {
                    const entryId = `feeEntry_${studentId}_${index}`;
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'section';
                    entryDiv.id = entryId;
                    
                    entryDiv.innerHTML = `
                        <h4>Fee Record #${index + 1} 
                            <button type="button" class="btn btn-danger" onclick="removeFeeEntry('${entryId}')" style="float:right; padding: 5px 10px;">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </h4>
                        
                        <input type="hidden" class="fee-id" value="${fee.id}">
                        
                        <label>Amount ($)</label>
                        <input type="number" class="fee-amount" min="0" step="0.01" value="${fee.amount}" required>
                        <div class="error-message">Please enter a valid amount.</div>
                        
                        <label>Date</label>
                        <input type="date" class="fee-date" value="${fee.date}" required>
                        <div class="error-message">Please select a date.</div>
                        
                        <label>Description</label>
                        <input type="text" class="fee-description" value="${fee.description}" required>
                        <div class="error-message">Please enter a description.</div>
                    `;
                    
                    if (feeEntriesContainer) {
                        feeEntriesContainer.appendChild(entryDiv);
                    }
                });
            }
            
            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-success';
            saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
            saveButton.onclick = function() { saveEditedFeeRecords(studentId); };
            
            if (feeEntriesContainer) {
                feeEntriesContainer.appendChild(saveButton);
                feeEntriesContainer.scrollIntoView();
            }
        }
        async function saveEditedFeeRecords(studentId) {
            const entries = document.querySelectorAll(`.section[id^="feeEntry_${studentId}_"]`);
            const updatedRecords = [];
            let isValid = true;
            entries.forEach(entry => {
                const amount = entry.querySelector('.fee-amount').value;
                const date = entry.querySelector('.fee-date').value;
                const description = entry.querySelector('.fee-description').value;
                
                if (!amount || isNaN(amount)) isValid = false;
                if (!date) isValid = false;
                if (!description.trim()) isValid = false;
            });
            if (!isValid) {
                showToast('Please fix errors before saving', 'error');
                return;
            }
            entries.forEach(entry => {
                updatedRecords.push({
                    id: entry.querySelector('.fee-id').value,
                    amount: parseFloat(entry.querySelector('.fee-amount').value),
                    date: entry.querySelector('.fee-date').value,
                    description: entry.querySelector('.fee-description').value,
                    year: new Date(entry.querySelector('.fee-date').value).getFullYear()
                });
            });
            feeRecords[studentId] = updatedRecords;
            try {
                await saveDataToFiles();
                showToast('Fee records updated successfully!', 'success');
                updateFeeStudentTable();
            } catch (error) {
                console.error("Error saving fee records:", error);
                showToast("Failed to save fee records. Please try again.", "error");
            }
        }
        function filterFeeStudents() {
            const searchTerm = document.getElementById('feeSearch')?.value.toLowerCase() || '';
            const filteredStudents = studentDatabase.filter(record =>
                record.student.name.toLowerCase().includes(searchTerm) ||
                record.studentId.toLowerCase().includes(searchTerm)
            );
            updateFeeStudentTable(filteredStudents);
        }
        function addFeeEntry() {
            const container = document.getElementById('feeEntriesContainer');
            if (!container) return;
            
            const entryCount = container.children.length + 1;
            
            const entryId = `feeEntry_${Date.now()}`;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'section';
            entryDiv.id = entryId;
            
            // Create student options
            let studentOptions = '<option value="">Select Student</option>';
            studentDatabase.forEach(student => {
                studentOptions += `<option value="${student.id}">${student.student.name} (${student.studentId})</option>`;
            });
            
            entryDiv.innerHTML = `
                <h4>Fee Entry #${entryCount} 
                    <button type="button" class="btn btn-danger" onclick="removeFeeEntry('${entryId}')" style="float:right; padding: 5px 10px;">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </h4>
                
                <label>Student</label>
                <select class="fee-student" required>
                    ${studentOptions}
                </select>
                <div class="error-message">Please select a student.</div>
                
                <label>Amount ($)</label>
                <input type="number" class="fee-amount" min="0" step="0.01" value="0" required>
                <div class="error-message">Please enter a valid amount.</div>
                
                <label>Date</label>
                <input type="date" class="fee-date" required>
                <div class="error-message">Please select a date.</div>
                
                <label>Description</label>
                <input type="text" class="fee-description" required>
                <div class="error-message">Please enter a description.</div>
            `;
            
            container.appendChild(entryDiv);
            
            // Add validation event listeners
            const inputs = entryDiv.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', function () {
                    validateFeeInput(this);
                });
            });
            
            // Set today's date as default
            const feeDate = entryDiv.querySelector('.fee-date');
            if (feeDate) {
                feeDate.value = new Date().toISOString().split('T')[0];
            }
        }
        function removeFeeEntry(entryId) {
            const entryElement = document.getElementById(entryId);
            if (entryElement) {
                entryElement.remove();
            }
        }
        function validateFeeInput(input) {
            const errorMsg = input.nextElementSibling;
            let isValid = true;
            
            if (input.type === 'number') {
                isValid = input.value !== '' && !isNaN(input.value) && parseFloat(input.value) >= 0;
            } else if (input.type === 'date') {
                isValid = input.value !== '';
            } else if (input.tagName === 'SELECT') {
                isValid = input.value !== '';
            } else {
                isValid = input.value.trim().length > 0;
            }
            
            if (isValid) {
                input.classList.remove('error');
                if (errorMsg) {
                    errorMsg.classList.remove('show');
                }
            } else {
                input.classList.add('error');
                if (errorMsg) {
                    errorMsg.classList.add('show');
                }
            }
            
            return isValid;
        }
        function addFeeEntryForStudent(studentId) {
            addFeeEntry();
            
            // Select the student in the newly created entry
            const container = document.getElementById('feeEntriesContainer');
            if (!container) return;
            
            const entries = container.querySelectorAll('.section[id^="feeEntry_"]');
            const lastEntry = entries[entries.length - 1];
            
            if (lastEntry) {
                const studentSelect = lastEntry.querySelector('.fee-student');
                if (studentSelect) {
                    studentSelect.value = studentId;
                }
            }
        }
        async function saveFeeRecords() {
            const entries = document.querySelectorAll('.section[id^="feeEntry_"]');
            let savedCount = 0;
            
            for (const entry of entries) {
                const entryId = entry.id;
                const studentId = entry.querySelector('.fee-student').value;
                const amountInput = entry.querySelector('.fee-amount');
                const dateInput = entry.querySelector('.fee-date');
                const descInput = entry.querySelector('.fee-description');
                
                // Validate entry
                let isValid = true;
                isValid = validateFeeInput(entry.querySelector('.fee-student')) && isValid;
                isValid = validateFeeInput(amountInput) && isValid;
                isValid = validateFeeInput(dateInput) && isValid;
                isValid = validateFeeInput(descInput) && isValid;
                
                if (!isValid || !studentId) {
                    showToast('Please fix errors in fee entries before saving.', 'error');
                    return;
                }
                
                // Create fee record
                const feeRecord = {
                    id: Date.now() + Math.random(),
                    amount: parseFloat(amountInput.value),
                    date: dateInput.value,
                    description: descInput.value,
                    year: new Date(dateInput.value).getFullYear()
                };
                
                // Add to student's fee records
                if (!feeRecords[studentId]) {
                    feeRecords[studentId] = [];
                }
                feeRecords[studentId].push(feeRecord);
                savedCount++;
            }
            
            if (savedCount > 0) {
                try {
                    await saveDataToFiles();
                    const feeEntriesContainer = document.getElementById('feeEntriesContainer');
                    if (feeEntriesContainer) {
                        feeEntriesContainer.innerHTML = '';
                    }
                    updateFeeStudentTable();
                    showToast(`${savedCount} fee record(s) saved successfully!`, 'success');
                } catch (error) {
                    console.error("Error saving fee records:", error);
                    showToast("Failed to save fee records. Please try again.", 'error');
                }
            } else {
                showToast('No valid fee records to save.', 'warning');
            }
        }
        // Fee Management Functions
        function updateFeeStudentTable(studentsToShow = null) {
            const tbody = document.getElementById('feeStudentTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const students = studentsToShow || studentDatabase;
            const feePerChild = 30; // $30 per child as pending amount
            
            students.forEach(student => {
                let totalPaid = 0;
                if (feeRecords[student.id]) {
                    feeRecords[student.id].forEach(fee => {
                        totalPaid += fee.amount;
                    });
                }
                
                // Calculate balance (pending amount)
                const balance = totalPaid >= feePerChild ? 0 : feePerChild - totalPaid;
                const balanceColor = balance === 0 ? '#4CAF50' : '#03A9F4'; // Green if paid, Sky blue if pending
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.studentId}</td>
                    <td>${student.student.name}</td>
                    <td>${student.student.grade}</td>
                    <td>${student.parent.name}</td>
                    <td style="color: ${balanceColor}; font-weight: bold;">
                        ${balance === 0 ? '0.00' : balance.toFixed(2)}
                    </td>
                    <td>
                        <button class="btn" onclick='viewIndividualFeeReport(${student.id})'><i class="fas fa-eye"></i> View</button>
                        <button class="btn btn-warning" onclick='editFeeRecords(${student.id})'><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn" onclick='addFeeEntryForStudent(${student.id})'><i class="fas fa-plus"></i> Add Payment</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        // Reports Functions
        function updateReports() {
            // Update statistics
            const totalStudentsElement = document.getElementById('totalStudents');
            if (totalStudentsElement) {
                totalStudentsElement.textContent = studentDatabase.length;
            }
            const totalTeachersElement = document.getElementById('totalTeachers');
            if (totalTeachersElement) {
                totalTeachersElement.textContent = teacherDatabase.length;
            }
            
            // Calculate total fees collected
            let totalFeesCollected = 0;
            Object.values(feeRecords).forEach(studentRecords => {
                studentRecords.forEach(record => {
                    totalFeesCollected += record.amount;
                });
            });
            const totalFeesCollectedElement = document.getElementById('totalFeesCollected');
            if (totalFeesCollectedElement) {
                totalFeesCollectedElement.textContent = totalFeesCollected.toFixed(2);
            }
            
            // Calculate average attendance
            let totalAttendanceRecords = 0;
            let totalPresent = 0;
            
            Object.values(attendanceData).forEach(studentData => {
                Object.values(studentData).forEach(yearData => {
                    Object.values(yearData).forEach(monthData => {
                        monthData.forEach(status => {
                            if (status !== null) {
                                totalAttendanceRecords++;
                                if (status === 'present') {
                                    totalPresent++;
                                }
                            }
                        });
                    });
                });
            });
            
            const attendanceRate = totalAttendanceRecords > 0 
                ? Math.round((totalPresent / totalAttendanceRecords) * 100) 
                : 0;
            const attendanceRateElement = document.getElementById('attendanceRate');
            if (attendanceRateElement) {
                attendanceRateElement.textContent = `${attendanceRate}%`;
            }
        }
        // Fee Chart
        let feeChart = null;
       
       function renderFeeChart() {
            const ctx = document.getElementById('feeChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (feeChart) {
                feeChart.destroy();
            }
            
            // Prepare data for chart
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            const monthlyFees = new Array(12).fill(0);
            
            // Calculate fees collected per month
            Object.values(feeRecords).forEach(studentRecords => {
                if (studentRecords && studentRecords.length > 0) {
                    studentRecords.forEach(record => {
                        if (record && record.date) {
                            const recordDate = new Date(record.date);
                            if (recordDate.getFullYear() === currentYear) {
                                const monthIndex = recordDate.getMonth();
                                monthlyFees[monthIndex] += record.amount || 0;
                            }
                        }
                    });
                }
            });
            
            // Create chart
            feeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: `Fees Collected (${currentYear})`,
                        data: monthlyFees,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }
        // Student Attendance Chart
        let studentAttendanceChart = null;
        function renderStudentAttendanceChart() {
            const ctx = document.getElementById('studentAttendanceChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (studentAttendanceChart) {
                studentAttendanceChart.destroy();
            }
            
            // Prepare data for chart
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            const monthlyPresent = new Array(12).fill(0);
            const monthlyAbsent = new Array(12).fill(0);
            const monthlyLate = new Array(12).fill(0);
            
            // Calculate attendance per month
            Object.values(attendanceData).forEach(studentData => {
                if (studentData[currentYear]) {
                    for (let month = 0; month < 12; month++) {
                        if (studentData[currentYear][month]) {
                            studentData[currentYear][month].forEach(status => {
                                if (status === 'present') monthlyPresent[month]++;
                                else if (status === 'absent') monthlyAbsent[month]++;
                                else if (status === 'late') monthlyLate[month]++;
                            });
                        }
                    }
                }
            });
            
            // Create chart
            studentAttendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Present',
                            data: monthlyPresent,
                            backgroundColor: 'rgba(76, 175, 80, 0.7)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Absent',
                            data: monthlyAbsent,
                            backgroundColor: 'rgba(244, 67, 54, 0.7)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Late',
                            data: monthlyLate,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Students'
                            }
                        }
                    }
                }
            });
        }
        // Teacher Attendance Chart
        let teacherAttendanceChart = null;
        function renderTeacherAttendanceChart() {
            const ctx = document.getElementById('teacherAttendanceChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (teacherAttendanceChart) {
                teacherAttendanceChart.destroy();
            }
            
            // Prepare data for chart
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            const monthlyPresent = new Array(12).fill(0);
            const monthlyAbsent = new Array(12).fill(0);
            const monthlyLate = new Array(12).fill(0);
            
            // Calculate attendance per month
            Object.values(teacherAttendanceData).forEach(teacherData => {
                if (teacherData[currentYear]) {
                    for (let month = 0; month < 12; month++) {
                        if (teacherData[currentYear][month]) {
                            teacherData[currentYear][month].forEach(status => {
                                if (status === 'present') monthlyPresent[month]++;
                                else if (status === 'absent') monthlyAbsent[month]++;
                                else if (status === 'late') monthlyLate[month]++;
                            });
                        }
                    }
                }
            });
            
            // Create chart
            teacherAttendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Present',
                            data: monthlyPresent,
                            backgroundColor: 'rgba(76, 175, 80, 0.7)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Absent',
                            data: monthlyAbsent,
                            backgroundColor: 'rgba(244, 67, 54, 0.7)',
                            borderColor: 'rgba(244, 67, 54, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Late',
                            data: monthlyLate,
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Teachers'
                            }
                        }
                    }
                }
            });
        }
        // Print Functions
        function showPrintPreview(type) {
            let content = '';
            
            switch (type) {
                case 'studentDetails':
                    // Get the currently viewed student ID from the modal content or a global variable
                    // For simplicity, let's assume studentDetailsModal is open and we can find the ID
                    // A more robust way would be to pass the ID when calling showPrintPreview
                    const studentDetailsContent = document.getElementById('studentDetailsContent');
                    if (studentDetailsContent) {
                        content = `
                            <div class="print-header">
                                <img src="${schoolLogo}" alt="School Logo">
                                <h1>${schoolName}</h1>
                                <p>${schoolAddress}</p>
                                <p>${schoolABN}</p>
                                <h2>Student Details</h2>
                            </div>
                            ${studentDetailsContent.innerHTML}
                        `;
                    }
                    break;
                    
                case 'teacherDetails':
                    const teacherDetailsContent = document.getElementById('teacherDetailsContent');
                    if (teacherDetailsContent) {
                        content = `
                            <div class="print-header">
                                <img src="${schoolLogo}" alt="School Logo">
                                <h1>${schoolName}</h1>
                                <p>${schoolAddress}</p>
                                <p>${schoolABN}</p>
                                <h2>Teacher Details</h2>
                            </div>
                            ${teacherDetailsContent.innerHTML}
                        `;
                    }
                    break;
                    
                case 'feeReport':
                    const feeReportContent = document.getElementById('feeReportContent');
                    if (feeReportContent) {
                        content = feeReportContent.innerHTML;
                    }
                    break;
                    
                case 'monthlyFeeReport':
                    const monthlyFeeReportContent = document.getElementById('monthlyFeeReportContent');
                    if (monthlyFeeReportContent) {
                        content = monthlyFeeReportContent.innerHTML;
                    }
                    break;
                    
                case 'individualFeeReport':
                    const individualFeeReportContent = document.getElementById('individualFeeReportContent');
                    if (individualFeeReportContent) {
                        content = individualFeeReportContent.innerHTML;
                    }
                    break;
            }
            
            if (content) {
                const printPreviewContent = document.getElementById('printPreviewContent');
                if (printPreviewContent) {
                    printPreviewContent.innerHTML = content;
                }
                const printPreviewModal = document.getElementById('printPreviewModal');
                if (printPreviewModal) {
                    printPreviewModal.style.display = 'block';
                }
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    modalOverlay.style.display = 'block';
                }
            }
        }
        function closePrintPreview() {
            const printPreviewModal = document.getElementById('printPreviewModal');
            if (printPreviewModal) {
                printPreviewModal.style.display = 'none';
            }
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        }
        function executePrint() {
            const printPreviewContent = document.getElementById('printPreviewContent');
            if (!printPreviewContent) return;
            
            const printContent = printPreviewContent.innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Print Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .print-header { text-align: center; margin-bottom: 30px; }
                            .print-header img { max-width: 100px; margin-bottom: 10px; }
                            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            .print-table th,
                            .print-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                            .print-table th { background: #f2f2f2; }
                            
                        </style>
                    </head>
                    <body>
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        // Modal Functions
        function closeModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        }
        // Toast Function
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const messageElement = document.getElementById('toast-message');
            
            if (toast && messageElement) {
                messageElement.textContent = message;
                toast.className = 'toast ' + type;
                toast.style.display = 'flex';
                
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        }
        function setupIOSClock() {
            const hourHand = document.querySelector('.ios-hour-hand');
            const minuteHand = document.querySelector('.ios-minute-hand');
            const secondHand = document.querySelector('.ios-second-hand');
            const timeDisplay = document.querySelector('.ios-time');
            const dateDisplay = document.querySelector('.ios-date');
            
            // Create minute marks
            const minuteMarks = document.querySelector('.ios-minute-marks');
            if (minuteMarks) {
                for (let i = 0; i < 60; i++) {
                    const mark = document.createElement('div');
                    mark.className = 'ios-minute-mark';
                    mark.style.transform = `rotate(${i * 6}deg)`;
                    minuteMarks.appendChild(mark);
                }
            }
            
            function updateClock() {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                
                // Analog clock
                const hourDegrees = (hours % 12) * 30 + (minutes * 0.5);
                const minuteDegrees = minutes * 6;
                const secondDegrees = seconds * 6;
                
                if (hourHand) {
                    hourHand.style.transform = `rotate(${hourDegrees}deg)`;
                }
                if (minuteHand) {
                    minuteHand.style.transform = `rotate(${minuteDegrees}deg)`;
                }
                if (secondHand) {
                    secondHand.style.transform = `rotate(${secondDegrees}deg)`;
                }
                
                // Digital clock
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                if (timeDisplay) {
                    timeDisplay.textContent = `${displayHours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                }
                
                // Date display
                const options = { weekday: 'short', month: 'short', day: 'numeric' };
                if (dateDisplay) {
                    dateDisplay.textContent = now.toLocaleDateString(undefined, options);
                }
            }
            
            // Initialize clock
            updateClock();
            // Update every second
            setInterval(updateClock, 1000);
        }
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', setupIOSClock);
        // Helper: Ensure Tuesday/Wednesday auto-absent rule
        function applyAutoAbsentRule(attendanceRecord, year, month) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, ...
                // If Tuesday (2) or Wednesday (3) and no record, mark as Absent
                if ((dayOfWeek === 2 || dayOfWeek === 3) && !attendanceRecord[d - 1]) {
                    attendanceRecord[d - 1] = "absent";
                }
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTabId = tab.getAttribute('data-tab');
                    
                    // Close any open modals when switching tabs
                    closeModals();
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show target content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetTabId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Update UI based on tab
                    if (targetTabId === 'databaseTab') {
                        updateDatabaseView();
                    }
                    if (targetTabId === 'teacherTab') {
                        updateTeacherView();
                        populateTeacherAttendanceSelect();
                        loadCLVRecords(); // Add this line
                    }
                    if (targetTabId === 'reportsTab') {
                        updateReports();
                        renderFeeChart();
                        renderStudentAttendanceChart();
                        renderTeacherAttendanceChart();
                    }
                    if (targetTabId === 'feeTab') {
                        updateFeeStudentTable(); // Add this line
                    }
                    if (targetTabId === 'attendanceTab') {
                        renderStudentList();
                        renderAttendanceCalendar();
                    }
                });
            });
            
            // Initialize the app
            initializeApp();
        });
        
        // Helper function to format status text
        function formatStatus(status) {
            switch(status) {
                case 'pending': return 'Pending';
                case 'completed': return 'Completed';
                case 'review': return 'Under Review';
                default: return status;
            }
        }
        // Update all export functions to use this pattern
async function exportStudentReport(format) {
    try {
        await ensureLibrariesLoaded();
        
        if (format === 'excel') {
            await exportStudentDataToExcel();
        } else if (format === 'pdf') {
            await exportStudentDataToPDF();
        }
    } catch (error) {
        console.error("Export failed:", error);
        showToast(`Export failed: ${error.message}`, "error");
    }
}

// Apply similar pattern to all export functions:
// exportTeacherReport, exportAttendanceReport, exportFeeReport
// Export Teacher Report
function exportTeacherReport(format) {
    if (format === 'excel') {
        exportTeacherDataToExcel();
    } else if (format === 'pdf') {
        exportTeacherDataToPDF();
    }
}
// Export Attendance Report
function exportAttendanceReport(format) {
    if (format === 'excel') {
        exportAttendanceDataToExcel();
    } else if (format === 'pdf') {
        exportAttendanceDataToPDF();
    }
}
// Export Fee Report
function exportFeeReport(format) {
    if (format === 'excel') {
        exportFeeDataToExcel();
    } else if (format === 'pdf') {
        exportFeeDataToPDF();
    }
}
// Export Student Data to Excel
function exportStudentDataToExcel() {
    try {
        const headers = [
            'ID', 'Student Name', 'Date of Birth', 'Grade',
            'Current School', 'Parent Name', 'Relationship',
            'Parent Phone', 'Parent Email'
        ];
        
        const data = studentDatabase.map(record => [
            record.studentId,
            record.student.name,
            record.student.dob,
            record.student.grade,
            record.student.currentSchool,
            record.parent.name,
            record.parent.relationship,
            record.parent.phone,
            record.parent.email
        ]);
        
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Students");
        
        XLSX.writeFile(wb, 'taha_student_data.xlsx');
        showToast('Student data exported to Excel successfully!', 'success');
    } catch (error) {
        console.error("Error exporting student data to Excel:", error);
        showToast('Failed to export student data to Excel.', 'error');
    }
}
// Export Student Data to PDF
function exportStudentDataToPDF() {
    try {
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm'
        });
        
        // Add header
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.setTextColor(40);
        doc.text('TAHA School - Student Report', 
                doc.internal.pageSize.width / 2, 
                15, 
                { align: 'center' });
        
        // Add current date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 
                doc.internal.pageSize.width - 10, 
                10, 
                { align: 'right' });
        
        // Prepare data
        const headers = [
            'ID',
            'Student Name',
            'Grade',
            'Parent Name', 
            'Parent Phone',
            'Parent Email'
        ];
        
        const data = studentDatabase.map(record => [
            record.studentId,
            record.student.name,
            record.student.grade,
            record.parent.name,
            record.parent.phone,
            record.parent.email
        ]);
        
        // Create table
        doc.autoTable({
            startY: 25,
            head: [headers],
            body: data,
            theme: 'grid',
            headStyles: {
                fillColor: [67, 97, 238],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            },
            margin: { top: 25 },
            styles: {
                fontSize: 9,
                cellPadding: 3,
                overflow: 'linebreak'
            }
        });
        
        // Save the PDF
        doc.save('taha_student_data.pdf');
        showToast('Student data exported to PDF successfully!', 'success');
    } catch (error) {
        console.error("Error exporting student data to PDF:", error);
        showToast('Failed to export student data to PDF.', 'error');
    }
}
// Export Teacher Data to Excel
function exportTeacherDataToExcel() {
    try {
        const headers = [
            'ID', 'Name', 'Subject', 'Phone', 'Email', 'WWCC Status'
        ];
        
        const data = teacherDatabase.map(teacher => [
            `TEA-${String(teacher.id).padStart(4, '0')}`,
            teacher.name,
            teacher.subject,
            teacher.phone,
            teacher.email,
            teacher.hasWwcc === 'yes' ? 'Valid' : 'No WWCC'
        ]);
        
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Teachers");
        
        XLSX.writeFile(wb, 'taha_teacher_data.xlsx');
        showToast('Teacher data exported to Excel successfully!', 'success');
    } catch (error) {
        console.error("Error exporting teacher data to Excel:", error);
        showToast('Failed to export teacher data to Excel.', 'error');
    }
}
// Export Teacher Data to PDF
function exportTeacherDataToPDF() {
    try {
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm'
        });
        
        // Add header
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.setTextColor(40);
        doc.text('TAHA School - Teacher Report', 
                doc.internal.pageSize.width / 2, 
                15, 
                { align: 'center' });
        
        // Add current date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 
                doc.internal.pageSize.width - 10, 
                10, 
                { align: 'right' });
        
        // Prepare data
        const headers = [
            'ID',
            'Name',
            'Subject',
            'Phone',
            'Email',
            'WWCC Status'
        ];
        
        const data = teacherDatabase.map(teacher => [
            `TEA-${String(teacher.id).padStart(4, '0')}`,
            teacher.name,
            teacher.subject,
            teacher.phone,
            teacher.email,
            teacher.hasWwcc === 'yes' ? 'Valid' : 'No WWCC'
        ]);
        
        // Create table
        doc.autoTable({
            startY: 25,
            head: [headers],
            body: data,
            theme: 'grid',
            headStyles: {
                fillColor: [67, 97, 238],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            },
            margin: { top: 25 },
            styles: {
                fontSize: 9,
                cellPadding: 3,
                overflow: 'linebreak'
            }
        });
        
        // Save the PDF
        doc.save('taha_teacher_data.pdf');
        showToast('Teacher data exported to PDF successfully!', 'success');
    } catch (error) {
        console.error("Error exporting teacher data to PDF:", error);
        showToast('Failed to export teacher data to PDF.', 'error');
    }
}
// Export Attendance Data to Excel
function exportAttendanceDataToExcel() {
    try {
        // Prepare data for all students
        const headers = ['Student ID', 'Student Name', 'Date', 'Status'];
        const data = [];
        
        // Process each student
        studentDatabase.forEach(student => {
            if (attendanceData[student.id]) {
                Object.keys(attendanceData[student.id]).forEach(year => {
                    Object.keys(attendanceData[student.id][year]).forEach(month => {
                        attendanceData[student.id][year][month].forEach((status, day) => {
                            if (status) {
                                const date = new Date(year, month, day + 1);
                                data.push([
                                    student.studentId,
                                    student.student.name,
                                    date.toISOString().split('T')[0],
                                    status
                                ]);
                            }
                        });
                    });
                });
            }
        });
        
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Attendance");
        
        XLSX.writeFile(wb, 'taha_attendance_data.xlsx');
        showToast('Attendance data exported to Excel successfully!', 'success');
    } catch (error) {
        console.error("Error exporting attendance data to Excel:", error);
        showToast('Failed to export attendance data to Excel.', 'error');
    }
}
// Export Attendance Data to PDF
function exportAttendanceDataToPDF() {
    try {
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm'
        });
        
        // Add header
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.setTextColor(40);
        doc.text('TAHA School - Attendance Report', 
                doc.internal.pageSize.width / 2, 
                15, 
                { align: 'center' });
        
        // Add current date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 
                doc.internal.pageSize.width - 10, 
                10, 
                { align: 'right' });
        
        // Prepare data
        const headers = [
            'Student ID',
            'Student Name',
            'Date',
            'Status'
        ];
        
        const data = [];
        
        // Process each student
        studentDatabase.forEach(student => {
            if (attendanceData[student.id]) {
                Object.keys(attendanceData[student.id]).forEach(year => {
                    Object.keys(attendanceData[student.id][year]).forEach(month => {
                        attendanceData[student.id][year][month].forEach((status, day) => {
                            if (status) {
                                const date = new Date(year, month, day + 1);
                                data.push([
                                    student.studentId,
                                    student.student.name,
                                    date.toISOString().split('T')[0],
                                    status
                                ]);
                            }
                        });
                    });
                });
            }
        });
        
        // Create table
        doc.autoTable({
            startY: 25,
            head: [headers],
            body: data,
            theme: 'grid',
            headStyles: {
                fillColor: [67, 97, 238],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            },
            margin: { top: 25 },
            styles: {
                fontSize: 9,
                cellPadding: 3,
                overflow: 'linebreak'
            }
        });
        
        // Save the PDF
        doc.save('taha_attendance_data.pdf');
        showToast('Attendance data exported to PDF successfully!', 'success');
    } catch (error) {
        console.error("Error exporting attendance data to PDF:", error);
        showToast('Failed to export attendance data to PDF.', 'error');
    }
}
// Export Fee Data to Excel
function exportFeeDataToExcel() {
    try {
        const headers = ['Student ID', 'Student Name', 'Parent Name', 'Date', 'Description', 'Amount'];
        const data = [];
        
        // Process each student
        studentDatabase.forEach(student => {
            if (feeRecords[student.id]) {
                feeRecords[student.id].forEach(fee => {
                    data.push([
                        student.studentId,
                        student.student.name,
                        student.parent.name,
                        fee.date,
                        fee.description,
                        fee.amount
                    ]);
                });
            }
        });
        
        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Fees");
        
        XLSX.writeFile(wb, 'taha_fee_data.xlsx');
        showToast('Fee data exported to Excel successfully!', 'success');
    } catch (error) {
        console.error("Error exporting fee data to Excel:", error);
        showToast('Failed to export fee data to Excel.', 'error');
    }
}
// Export Fee Data to PDF
function exportFeeDataToPDF() {
    try {
        const doc = new jsPDF({
            orientation: 'landscape',
            unit: 'mm'
        });
        
        // Add header
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.setTextColor(40);
        doc.text('TAHA School - Fee Report', 
                doc.internal.pageSize.width / 2, 
                15, 
                { align: 'center' });
        
        // Add current date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 
                doc.internal.pageSize.width - 10, 
                10, 
                { align: 'right' });
        
        // Prepare data
        const headers = [
            'Student ID',
            'Student Name',
            'Parent Name',
            'Date',
            'Description',
            'Amount'
        ];
        
        const data = [];
        
        // Process each student
        studentDatabase.forEach(student => {
            if (feeRecords[student.id]) {
                feeRecords[student.id].forEach(fee => {
                    data.push([
                        student.studentId,
                        student.student.name,
                        student.parent.name,
                        fee.date,
                        fee.description,
                        `$${fee.amount.toFixed(2)}`
                    ]);
                });
            }
        });
        
        // Create table
        doc.autoTable({
            startY: 25,
            head: [headers],
            body: data,
            theme: 'grid',
            headStyles: {
                fillColor: [67, 97, 238],
                textColor: 255,
                fontStyle: 'bold'
            },
            alternateRowStyles: {
                fillColor: [240, 240, 240]
            },
            margin: { top: 25 },
            styles: {
                fontSize: 9,
                cellPadding: 3,
                overflow: 'linebreak'
            }
        });
        
        // Save the PDF
        doc.save('taha_fee_data.pdf');
        showToast('Fee data exported to PDF successfully!', 'success');
    } catch (error) {
        console.error("Error exporting fee data to PDF:", error);
        showToast('Failed to export fee data to PDF.', 'error');
    }
}
// Import Data Function
function importData(event, dataType) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            let importedData = [];
            
            if (file.name.endsWith('.json')) {
                importedData = JSON.parse(e.target.result);
            } else if (file.name.endsWith('.csv')) {
                // Simple CSV parser
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    const record = {};
                    
                    headers.forEach((header, index) => {
                        record[header] = values[index];
                    });
                    
                    importedData.push(record);
                }
            } else if (file.name.endsWith('.xlsx')) {
                // Handle Excel import
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                importedData = XLSX.utils.sheet_to_json(firstSheet);
            } else {
                showToast('Unsupported file format. Please use JSON, CSV, or Excel.', 'error');
                return;
            }
            
            // Process the imported data based on the data type
            if (dataType === 'student') {
                await processImportedStudentData(importedData);
            } else if (dataType === 'teacher') {
                await processImportedTeacherData(importedData);
            } else if (dataType === 'attendance') {
                await processImportedAttendanceData(importedData);
            } else if (dataType === 'fee') {
                await processImportedFeeData(importedData);
            }
            
            showToast(`${dataType.charAt(0).toUpperCase() + dataType.slice(1)} data imported successfully!`, 'success');
            
            // Update UI
            updateDatabaseView();
            updateTeacherView();
            updateReports();
            renderStudentList();
            updateFeeStudentTable();
            
            // Save data to files
            await saveDataToFiles();
        } catch (error) {
            console.error('Error importing data:', error);
            showToast('Error importing data. Please check the file format.', 'error');
        }
    };
    
    if (file.name.endsWith('.json')) {
        reader.readAsText(file);
    } else if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
    } else if (file.name.endsWith('.xlsx')) {
        reader.readAsArrayBuffer(file);
    } else {
        showToast('Unsupported file format. Please use JSON, CSV, or Excel.', 'error');
    }
}
// Process Imported Student Data
function processImportedStudentData(importedData) {
    importedData.forEach(record => {
        // Generate a new ID for the student
        const newStudentIdNumber = nextStudentId++;
        const newStudentId = `TAS-${String(newStudentIdNumber).padStart(5, '0')}`;
        
        const studentRecord = {
            id: Date.now() + Math.random(),
            studentId: newStudentId,
            student: {
                name: record['Student Name'] || record.name || '',
                dob: record['Date of Birth'] || record.dob || '',
                grade: record['Grade'] || record.grade || '',
                currentSchool: record['Current School'] || record.currentSchool || ''
            },
            parent: {
                name: record['Parent Name'] || record.parentName || '',
                relationship: record['Relationship'] || record.relationship || '',
                phone: record['Parent Phone'] || record.parentPhone || '',
                email: record['Parent Email'] || record.parentEmail || ''
            }
        };
        
        studentDatabase.push(studentRecord);
        
        // Initialize attendance data for the new student
        if (!attendanceData[studentRecord.id]) {
            attendanceData[studentRecord.id] = {};
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                attendanceData[studentRecord.id][y] = {};
                for (let m = 0; m < 12; m++) {
                    attendanceData[studentRecord.id][y][m] = Array(getDaysInMonth(y, m)).fill(null);
                }
            }
        }
        
        // Initialize fee records for the new student
        if (!feeRecords[studentRecord.id]) {
            feeRecords[studentRecord.id] = [];
        }
    });
}
// Process Imported Teacher Data
function processImportedTeacherData(importedData) {
    importedData.forEach(record => {
        const teacherRecord = {
            id: nextTeacherId++,
            name: record['Name'] || record.name || '',
            subject: record['Subject'] || record.subject || '',
            phone: record['Phone'] || record.phone || '',
            email: record['Email'] || record.email || '',
            hasWwcc: record['WWCC Status'] || record.hasWwcc || 'no'
        };
        
        teacherDatabase.push(teacherRecord);
        
        // Initialize attendance data for the new teacher
        if (!teacherAttendanceData[teacherRecord.id]) {
            teacherAttendanceData[teacherRecord.id] = {};
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                teacherAttendanceData[teacherRecord.id][y] = {};
                for (let m = 0; m < 12; m++) {
                    teacherAttendanceData[teacherRecord.id][y][m] = Array(getDaysInMonth(y, m)).fill(null);
                }
            }
        }
    });
}
// Process Imported Attendance Data
function processImportedAttendanceData(importedData) {
    importedData.forEach(record => {
        const studentId = record['Student ID'] || record.studentId;
        const date = new Date(record['Date'] || record.date);
        const status = record['Status'] || record.status;
        
        // Find the student
        const student = studentDatabase.find(s => s.studentId === studentId);
        if (!student) return;
        
        const year = date.getFullYear();
        const month = date.getMonth();
        const day = date.getDate() - 1; // Array is 0-indexed
        
        // Initialize attendance data if not exists
        if (!attendanceData[student.id]) {
            attendanceData[student.id] = {};
        }
        if (!attendanceData[student.id][year]) {
            attendanceData[student.id][year] = {};
        }
        if (!attendanceData[student.id][year][month]) {
            attendanceData[student.id][year][month] = Array(getDaysInMonth(year, month)).fill(null);
        }
        
        // Set the attendance status
        attendanceData[student.id][year][month][day] = status;
    });
}
// Process Imported Fee Data
function processImportedFeeData(importedData) {
    importedData.forEach(record => {
        const studentId = record['Student ID'] || record.studentId;
        const date = record['Date'] || record.date;
        const description = record['Description'] || record.description;
        const amount = parseFloat(record['Amount'] || record.amount) || 0;
        
        // Find the student
        const student = studentDatabase.find(s => s.studentId === studentId);
        if (!student) return;
        
        // Initialize fee records if not exists
        if (!feeRecords[student.id]) {
            feeRecords[student.id] = [];
        }
        
        // Add the fee record
        feeRecords[student.id].push({
            id: Date.now() + Math.random(),
            date: date,
            description: description,
            amount: amount,
            year: new Date(date).getFullYear()
        });
    });
}
// Add this function to check and load libraries
async function ensureLibrariesLoaded() {
    // Check for XLSX library
    if (typeof XLSX === 'undefined') {
        console.log("Loading XLSX library...");
        await loadScript('https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js');
    }
    
    // Check for jsPDF library
    if (typeof jsPDF === 'undefined') {
        console.log("Loading jsPDF library...");
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js');
        
        // Initialize jsPDF from UMD module
        if (window.jspdf && window.jspdf.jsPDF) {
            window.jsPDF = window.jspdf.jsPDF;
        }
    }
}

// Helper function to load scripts dynamically
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}
    </script>
<!-- Assistant Container -->
<div id="assistant-container">
    <div id="assistant-button" onclick="toggleAssistant()">
        <i class="fas fa-comments"></i>
    </div>
    <div id="assistant-window">
        <div id="assistant-header">
            <div id="assistant-title">TAHA Assistant</div>
            <button onclick="toggleAssistant()">&times;</button>
        </div>
        <div id="assistant-messages">
            <div class="assistant-message bot-message">
                Hello! I'm your TAHA School Management Assistant. How can I help you today?
            </div>
        </div>
        <div id="assistant-input-container">
            <input type="text" id="assistant-input" placeholder="Type your question here..." onkeypress="handleAssistantKeyPress(event)">
            <button onclick="sendAssistantMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<style>
/* Assistant Styles */
#assistant-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#assistant-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    font-size: 24px;
}

#assistant-button:hover {
    background: var(--secondary);
    transform: scale(1.05);
}

#assistant-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 350px;
    height: 450px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    display: none;
    flex-direction: column;
    overflow: hidden;
}

#assistant-header {
    background: var(--primary);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#assistant-title {
    font-weight: 600;
    font-size: 1.1rem;
}

#assistant-header button {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

#assistant-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.assistant-message {
    max-width: 80%;
    padding: 12px;
    border-radius: 18px;
    line-height: 1.4;
}

.user-message {
    background: var(--primary);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.bot-message {
    background: var(--bg-light);
    color: var(--text-primary);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

#assistant-input-container {
    display: flex;
    padding: 15px;
    border-top: 1px solid var(--border);
}

#assistant-input {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 10px 15px;
    outline: none;
}

#assistant-input:focus {
    border-color: var(--primary);
}

#assistant-input-container button {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    margin-left: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.assistant-suggestion {
    display: inline-block;
    background: var(--bg-light);
    color: var(--primary);
    border: 1px solid var(--border);
    border-radius: 15px;
    padding: 5px 12px;
    margin: 5px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.assistant-suggestion:hover {
    background: var(--primary);
    color: white;
}
</style>

<script>
// Assistant functionality
let assistantOpen = false;

function toggleAssistant() {
    assistantOpen = !assistantOpen;
    const assistantWindow = document.getElementById('assistant-window');
    assistantWindow.style.display = assistantOpen ? 'flex' : 'none';
    
    if (assistantOpen) {
        document.getElementById('assistant-input').focus();
    }
}

function handleAssistantKeyPress(event) {
    if (event.key === 'Enter') {
        sendAssistantMessage();
    }
}

function sendAssistantMessage() {
    const input = document.getElementById('assistant-input');
    const message = input.value.trim();
    
    if (message === '') return;
    
    // Add user message to chat
    addAssistantMessage(message, 'user');
    input.value = '';
    
    // Generate bot response
    setTimeout(() => {
        const response = generateAssistantResponse(message);
        addAssistantMessage(response, 'bot');
    }, 500);
}

function addAssistantMessage(message, sender) {
    const messagesContainer = document.getElementById('assistant-messages');
    const messageElement = document.createElement('div');
    messageElement.classList.add('assistant-message', sender === 'user' ? 'user-message' : 'bot-message');
    messageElement.textContent = message;
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function generateAssistantResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // Registration related queries
    if (lowerMessage.includes('register') || lowerMessage.includes('enrol') || lowerMessage.includes('new student')) {
        return "To register a new student, go to the Registration tab. Fill in the parent/guardian details and then add each child using the 'Add Child' button. Make sure to fill all required fields before saving.";
    }
    
    // Student database queries
    if (lowerMessage.includes('student') && (lowerMessage.includes('find') || lowerMessage.includes('search') || lowerMessage.includes('look up'))) {
        return "You can search for students in the Student Database tab. Use the search box to find students by name, ID, or parent information. You can also export student data to Excel or PDF.";
    }
    
    // Attendance queries
    if (lowerMessage.includes('attendance')) {
        return "For attendance tracking, go to the Attendance tab. Select a student from the list, then mark their attendance on the calendar. You can mark students as Present, Absent, or Late by clicking on the calendar days.";
    }
    
    // Fee management queries
    if (lowerMessage.includes('fee') || lowerMessage.includes('payment') || lowerMessage.includes('invoice')) {
        return "For fee management, go to the Fee Management tab. You can view student fee records, add new payments, and generate fee reports. Each student has a balance showing any outstanding fees.";
    }
    
    // Teacher management queries
    if (lowerMessage.includes('teacher')) {
        return "For teacher management, go to the Teacher tab. You can add new teachers, view their details, and track their attendance. Teachers also need a valid WWCC (Working With Children Check).";
    }
    
    // CLV form queries
    if (lowerMessage.includes('clv') || lowerMessage.includes('learning verification')) {
        return "The CLV (Child Learning Verification) form is in the Teacher tab. Select a student, fill in their learning assessment, skills evaluation, and recommendations. You can save drafts or submit completed forms.";
    }
    
    // Report queries
    if (lowerMessage.includes('report') || lowerMessage.includes('analytics') || lowerMessage.includes('statistics')) {
        return "For reports and analytics, go to the Reports tab. You can view statistics about students, teachers, fees, and attendance. You can also generate various charts and export data.";
    }
    
    // Export/import queries
    if (lowerMessage.includes('export') || lowerMessage.includes('import') || lowerMessage.includes('backup')) {
        return "You can export and import data from the Reports tab. You can export student, teacher, attendance, and fee data to Excel or PDF formats. You can also import data from JSON, CSV, or Excel files.";
    }
    
    // Default response
    return "I'm here to help with the TAHA School Management System. You can ask me about student registration, attendance tracking, fee management, teacher management, CLV forms, reports, or data export/import. How can I assist you today?";
}

// Add some suggested questions when assistant is opened
document.addEventListener('DOMContentLoaded', function() {
    const assistantButton = document.getElementById('assistant-button');
    if (assistantButton) {
        assistantButton.addEventListener('click', function() {
            if (assistantOpen) {
                const messagesContainer = document.getElementById('assistant-messages');
                
                // Only add suggestions if they don't already exist
                if (!document.querySelector('.assistant-suggestions')) {
                    const suggestionsDiv = document.createElement('div');
                    suggestionsDiv.className = 'assistant-suggestions';
                    suggestionsDiv.innerHTML = `
                        <p style="margin: 10px 0 5px; font-size: 0.9rem; color: var(--text-secondary);">Try asking:</p>
                        <div class="assistant-suggestion" onclick="useSuggestion('How do I register a new student?')">How do I register a new student?</div>
                        <div class="assistant-suggestion" onclick="useSuggestion('How do I track attendance?')">How do I track attendance?</div>
                        <div class="assistant-suggestion" onclick="useSuggestion('How do I manage fees?')">How do I manage fees?</div>
                        <div class="assistant-suggestion" onclick="useSuggestion('How do I create reports?')">How do I create reports?</div>
                    `;
                    messagesContainer.appendChild(suggestionsDiv);
                }
            }
        });
    }
});

function useSuggestion(question) {
    document.getElementById('assistant-input').value = question;
    sendAssistantMessage();
}
</script>
</body>
</html>
